+ set -e
+ LOG_DIR=20220903
+ JOBS=4
+ CLIENTS=16
+ DURATION_RO=900
+ DURATION_RW=3600
+ RUNS_RO=1
+ RUNS_RW=1
+ DATADIR=/mnt/zfs_raid/pg/data
+ recordsize=8K
+ compression=lz4
+ atime=off
+ relatime=on
+ logbias=latency
+ redundant_metadata=most
+ for level in stripe mirror raidz1 raidz2 raidz3
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/stripe/default
+ '[' -d 20220903/stripe/default ']'
+ mkdir -p 20220903/stripe/default
+ CSV='stripe;default'
+ echo '===== default stripe ====='
===== default stripe =====
+ l=stripe
+ '[' stripe == stripe ']'
+ l=
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-default.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/stripe/default/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/stripe/default/50
++ date +%s
+ t1=1662249378
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662249378.576765
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/18810A8
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662249378.576765'
+ d=9.314630
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/18810A8'\'')'
+ w=644061736
++ date +%s
+ t2=1662249387
+ echo '1662249378;1662249387;stripe;default;50;init;9.314630;644061736'
++ date +%s
+ t1=1662249387
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662249387.899170
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBAAD0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662249387.899170'
+ d=0.028107
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBAAD0'\'')'
+ w=62768
++ date +%s
+ t2=1662249387
+ echo '1662249387;1662249387;stripe;default;50;vacuum;0.028107;62768'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/default/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662249388
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/stripe/default/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662249388.232722
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27ECA2A0
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/default/50/run-rw-1/pgbench_log.tgz pgbench_log.27716 pgbench_log.27716.1 pgbench_log.27716.2 pgbench_log.27716.3
+ rm -f pgbench_log.27716 pgbench_log.27716.1 pgbench_log.27716.2 pgbench_log.27716.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662249388.232722'
+ d=3601.239494
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27ECA2A0'\'')'
+ w=21254041392
++ date +%s
+ t2=1662252989
++ cat 20220903/stripe/default/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=19351.713307
+ echo '1662249388;1662252989;stripe;default;50;rw;19351.713307;3601.239494;21254041392'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=4353114112
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=4472943419
+ echo 'after;4353114112;112386048;4472943419'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/stripe/default/250
++ date +%s
+ t1=1662253049
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662253049.932029
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/1B028F50
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662253049.932029'
+ d=41.839985
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/1B028F50'\'')'
+ w=3220063832
++ date +%s
+ t2=1662253091
+ echo '1662253049;1662253091;stripe;default;250;init;41.839985;3220063832'
++ date +%s
+ t1=1662253091
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662253091.779514
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/DAF0D5A8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662253091.779514'
+ d=0.035728
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/DAF0D5A8'\'')'
+ w=76376
++ date +%s
+ t2=1662253091
+ echo '1662253091;1662253091;stripe;default;250;vacuum;0.035728;76376'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/default/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662253091
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/stripe/default/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662253091.849762
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/DAF20000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/default/250/run-ro-1/pgbench_log.tgz pgbench_log.19893 pgbench_log.19893.1 pgbench_log.19893.2 pgbench_log.19893.3
+ rm -f pgbench_log.19893 pgbench_log.19893.1 pgbench_log.19893.2 pgbench_log.19893.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662253091.849762'
+ d=901.054708
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/DAF20000'\'')'
+ w=8280
++ date +%s
+ t2=1662253992
++ cat 20220903/stripe/default/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70865.949231
+ echo '1662253091;1662253992;stripe;default;250;ro;70865.949231;901.054708;8280'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/default/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662254052
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/stripe/default/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662254052.971192
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/DAF22108
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/default/250/run-rw-1/pgbench_log.tgz pgbench_log.25911 pgbench_log.25911.1 pgbench_log.25911.2 pgbench_log.25911.3
+ rm -f pgbench_log.25911 pgbench_log.25911.1 pgbench_log.25911.2 pgbench_log.25911.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662254052.971192'
+ d=3600.930165
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/DAF22108'\'')'
+ w=28080701112
++ date +%s
+ t2=1662257653
++ cat 20220903/stripe/default/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=13617.917542
+ echo '1662254052;1662257653;stripe;default;250;rw;13617.917542;3600.930165;28080701112'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=6044516352
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=6613668667
+ echo 'after;6044516352;561651712;6613668667'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/stripe/default/1000
++ date +%s
+ t1=1662257714
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662257714.652110
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=C/64EE7468
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662257714.652110'
+ d=189.220859
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''C/64EE7468'\'')'
+ w=12880076480
++ date +%s
+ t2=1662257903
+ echo '1662257714;1662257903;stripe;default;1000;init;189.220859;12880076480'
++ date +%s
+ t1=1662257903
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662257903.881733
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=F/64A4D328
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662257903.881733'
+ d=0.048208
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''F/64A4D328'\'')'
+ w=183512
++ date +%s
+ t2=1662257903
+ echo '1662257903;1662257903;stripe;default;1000;vacuum;0.048208;183512'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/default/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662257903
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/stripe/default/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662257903.968205
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=F/64A7A000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/default/1000/run-ro-1/pgbench_log.tgz pgbench_log.7358 pgbench_log.7358.1 pgbench_log.7358.2 pgbench_log.7358.3
+ rm -f pgbench_log.7358 pgbench_log.7358.1 pgbench_log.7358.2 pgbench_log.7358.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662257903.968205'
+ d=900.690822
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''F/64A7A000'\'')'
+ w=5552
++ date +%s
+ t2=1662258804
++ cat 20220903/stripe/default/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=42856.821033
+ echo '1662257903;1662258804;stripe;default;1000;ro;42856.821033;900.690822;5552'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/default/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662258864
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/stripe/default/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662258864.733641
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=F/64A7B660
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/default/1000/run-rw-1/pgbench_log.tgz pgbench_log.31793 pgbench_log.31793.1 pgbench_log.31793.2 pgbench_log.31793.3
+ rm -f pgbench_log.31793 pgbench_log.31793.1 pgbench_log.31793.2 pgbench_log.31793.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662258864.733641'
+ d=3600.474323
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''F/64A7B660'\'')'
+ w=59438892592
++ date +%s
+ t2=1662262465
++ cat 20220903/stripe/default/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=5803.410436
+ echo '1662258864;1662262465;stripe;default;1000;rw;5803.410436;3600.474323;59438892592'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14752432128
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=17006416699
+ echo 'after;14752432128;2246483968;17006416699'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/stripe/default/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/stripe/no-fpw
+ '[' -d 20220903/stripe/no-fpw ']'
+ mkdir -p 20220903/stripe/no-fpw
+ CSV='stripe;no-fpw'
+ echo '===== no-fpw stripe ====='
===== no-fpw stripe =====
+ l=stripe
+ '[' stripe == stripe ']'
+ l=
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/stripe/no-fpw/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/stripe/no-fpw/50
++ date +%s
+ t1=1662262529
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662262529.148285
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662262529.148285'
+ d=9.476612
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020656
++ date +%s
+ t2=1662262538
+ echo '1662262529;1662262538;stripe;no-fpw;50;init;9.476612;644020656'
++ date +%s
+ t1=1662262538
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662262538.633225
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB06E8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662262538.633225'
+ d=0.029737
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB06E8'\'')'
+ w=39192
++ date +%s
+ t2=1662262538
+ echo '1662262538;1662262538;stripe;no-fpw;50;vacuum;0.029737;39192'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662262538
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/stripe/no-fpw/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662262538.946249
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBD88
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw/50/run-rw-1/pgbench_log.tgz pgbench_log.25303 pgbench_log.25303.1 pgbench_log.25303.2 pgbench_log.25303.3
+ rm -f pgbench_log.25303 pgbench_log.25303.1 pgbench_log.25303.2 pgbench_log.25303.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662262538.946249'
+ d=3601.227403
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBD88'\'')'
+ w=17864905256
++ date +%s
+ t2=1662266140
++ cat 20220903/stripe/no-fpw/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=19144.166409
+ echo '1662262538;1662266140;stripe;no-fpw;50;rw;19144.166409;3601.227403;17864905256'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=4312735744
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=4432565051
+ echo 'after;4312735744;112386048;4432565051'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/stripe/no-fpw/250
++ date +%s
+ t1=1662266200
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662266200.623268
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/50FF6708
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662266200.623268'
+ d=42.380602
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/50FF6708'\'')'
+ w=3219940640
++ date +%s
+ t2=1662266243
+ echo '1662266200;1662266243;stripe;no-fpw;250;init;42.380602;3219940640'
++ date +%s
+ t1=1662266243
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662266243.012434
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/10EBCC28
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662266243.012434'
+ d=0.036496
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/10EBCC28'\'')'
+ w=70616
++ date +%s
+ t2=1662266243
+ echo '1662266243;1662266243;stripe;no-fpw;250;vacuum;0.036496;70616'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662266243
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/stripe/no-fpw/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662266243.084997
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/10ECE000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw/250/run-ro-1/pgbench_log.tgz pgbench_log.16775 pgbench_log.16775.1 pgbench_log.16775.2 pgbench_log.16775.3
+ rm -f pgbench_log.16775 pgbench_log.16775.1 pgbench_log.16775.2 pgbench_log.16775.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662266243.084997'
+ d=901.041326
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/10ECE000'\'')'
+ w=5800
++ date +%s
+ t2=1662267144
++ cat 20220903/stripe/no-fpw/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70196.843108
+ echo '1662266243;1662267144;stripe;no-fpw;250;ro;70196.843108;901.041326;5800'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662267204
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/stripe/no-fpw/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662267204.192777
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/10ECF758
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw/250/run-rw-1/pgbench_log.tgz pgbench_log.22666 pgbench_log.22666.1 pgbench_log.22666.2 pgbench_log.22666.3
+ rm -f pgbench_log.22666 pgbench_log.22666.1 pgbench_log.22666.2 pgbench_log.22666.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662267204.192777'
+ d=3600.970364
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/10ECF758'\'')'
+ w=13106519280
++ date +%s
+ t2=1662270805
++ cat 20220903/stripe/no-fpw/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=13791.283226
+ echo '1662267204;1662270805;stripe;no-fpw;250;rw;13791.283226;3600.970364;13106519280'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=6074523648
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=6643675963
+ echo 'after;6074523648;561651712;6643675963'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/stripe/no-fpw/1000
++ date +%s
+ t1=1662270865
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662270865.894613
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=8/1E616CB0
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662270865.894613'
+ d=202.143527
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''8/1E616CB0'\'')'
+ w=12879641032
++ date +%s
+ t2=1662271068
+ echo '1662270865;1662271068;stripe;no-fpw;1000;init;202.143527;12879641032'
++ date +%s
+ t1=1662271068
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662271068.050503
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=B/1E112678
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662271068.050503'
+ d=0.065264
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''B/1E112678'\'')'
+ w=178568
++ date +%s
+ t2=1662271068
+ echo '1662271068;1662271068;stripe;no-fpw;1000;vacuum;0.065264;178568'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662271068
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/stripe/no-fpw/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662271068.152424
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=B/1E13E000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw/1000/run-ro-1/pgbench_log.tgz pgbench_log.26314 pgbench_log.26314.1 pgbench_log.26314.2 pgbench_log.26314.3
+ rm -f pgbench_log.26314 pgbench_log.26314.1 pgbench_log.26314.2 pgbench_log.26314.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662271068.152424'
+ d=900.685059
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''B/1E13E000'\'')'
+ w=2280
++ date +%s
+ t2=1662271968
++ cat 20220903/stripe/no-fpw/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=42845.257615
+ echo '1662271068;1662271968;stripe;no-fpw;1000;ro;42845.257615;900.685059;2280'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662272028
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/stripe/no-fpw/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662272028.911495
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=B/1E13E998
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw/1000/run-rw-1/pgbench_log.tgz pgbench_log.11868 pgbench_log.11868.1 pgbench_log.11868.2 pgbench_log.11868.3
+ rm -f pgbench_log.11868 pgbench_log.11868.1 pgbench_log.11868.2 pgbench_log.11868.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662272028.911495'
+ d=3600.526853
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''B/1E13E998'\'')'
+ w=6459219576
++ date +%s
+ t2=1662275629
++ cat 20220903/stripe/no-fpw/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=6607.078291
+ echo '1662272028;1662275629;stripe;no-fpw;1000;rw;6607.078291;3600.526853;6459219576'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14903730176
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=17157714747
+ echo 'after;14903730176;2246483968;17157714747'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/stripe/no-fpw/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/stripe/no-fpw-tuned
+ '[' -d 20220903/stripe/no-fpw-tuned ']'
+ mkdir -p 20220903/stripe/no-fpw-tuned
+ CSV='stripe;no-fpw-tuned'
+ echo '===== no-fpw-tuned stripe ====='
===== no-fpw-tuned stripe =====
+ l=stripe
+ '[' stripe == stripe ']'
+ l=
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw-tuned.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/stripe/no-fpw-tuned/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/stripe/no-fpw-tuned/50
++ date +%s
+ t1=1662275693
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662275693.408731
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662275693.408731'
+ d=8.498605
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020656
++ date +%s
+ t2=1662275701
+ echo '1662275693;1662275701;stripe;no-fpw-tuned;50;init;8.498605;644020656'
++ date +%s
+ t1=1662275701
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662275701.915960
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB06E8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662275701.915960'
+ d=0.029283
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB06E8'\'')'
+ w=39192
++ date +%s
+ t2=1662275701
+ echo '1662275701;1662275701;stripe;no-fpw-tuned;50;vacuum;0.029283;39192'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw-tuned/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662275702
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/stripe/no-fpw-tuned/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662275702.149498
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBD88
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw-tuned/50/run-rw-1/pgbench_log.tgz pgbench_log.32638 pgbench_log.32638.1 pgbench_log.32638.2 pgbench_log.32638.3
+ rm -f pgbench_log.32638 pgbench_log.32638.1 pgbench_log.32638.2 pgbench_log.32638.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662275702.149498'
+ d=3601.235924
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBD88'\'')'
+ w=18048356728
++ date +%s
+ t2=1662279303
++ cat 20220903/stripe/no-fpw-tuned/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=19343.683974
+ echo '1662275702;1662279303;stripe;no-fpw-tuned;50;rw;19343.683974;3601.235924;18048356728'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=4349411328
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=4469240635
+ echo 'after;4349411328;112386048;4469240635'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/stripe/no-fpw-tuned/250
++ date +%s
+ t1=1662279363
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662279364.003022
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/5BEEA668
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662279364.003022'
+ d=40.560497
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/5BEEA668'\'')'
+ w=3219940632
++ date +%s
+ t2=1662279404
+ echo '1662279363;1662279404;stripe;no-fpw-tuned;250;init;40.560497;3219940632'
++ date +%s
+ t1=1662279404
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662279404.572178
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/1BDB0B80
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662279404.572178'
+ d=0.036230
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/1BDB0B80'\'')'
+ w=70784
++ date +%s
+ t2=1662279404
+ echo '1662279404;1662279404;stripe;no-fpw-tuned;250;vacuum;0.036230;70784'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw-tuned/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662279404
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/stripe/no-fpw-tuned/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662279404.644677
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/1BDC2000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw-tuned/250/run-ro-1/pgbench_log.tgz pgbench_log.20780 pgbench_log.20780.1 pgbench_log.20780.2 pgbench_log.20780.3
+ rm -f pgbench_log.20780 pgbench_log.20780.1 pgbench_log.20780.2 pgbench_log.20780.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662279404.644677'
+ d=901.041179
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/1BDC2000'\'')'
+ w=5632
++ date +%s
+ t2=1662280305
++ cat 20220903/stripe/no-fpw-tuned/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70383.228767
+ echo '1662279404;1662280305;stripe;no-fpw-tuned;250;ro;70383.228767;901.041179;5632'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw-tuned/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662280365
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/stripe/no-fpw-tuned/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662280365.751900
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/1BDC36B0
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw-tuned/250/run-rw-1/pgbench_log.tgz pgbench_log.32661 pgbench_log.32661.1 pgbench_log.32661.2 pgbench_log.32661.3
+ rm -f pgbench_log.32661 pgbench_log.32661.1 pgbench_log.32661.2 pgbench_log.32661.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662280365.751900'
+ d=3600.941372
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/1BDC36B0'\'')'
+ w=13168627680
++ date +%s
+ t2=1662283966
++ cat 20220903/stripe/no-fpw-tuned/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=13861.259938
+ echo '1662280365;1662283966;stripe;no-fpw-tuned;250;rw;13861.259938;3600.941372;13168627680'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=6087409664
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=6656561979
+ echo 'after;6087409664;561651712;6656561979'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/stripe/no-fpw-tuned/1000
++ date +%s
+ t1=1662284027
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662284027.646762
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=8/2D40E3F0
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662284027.646762'
+ d=191.064035
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''8/2D40E3F0'\'')'
+ w=12879640912
++ date +%s
+ t2=1662284218
+ echo '1662284027;1662284218;stripe;no-fpw-tuned;1000;init;191.064035;12879640912'
++ date +%s
+ t1=1662284218
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662284218.719411
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=B/2CF09D40
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662284218.719411'
+ d=0.048874
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''B/2CF09D40'\'')'
+ w=172736
++ date +%s
+ t2=1662284218
+ echo '1662284218;1662284218;stripe;no-fpw-tuned;1000;vacuum;0.048874;172736'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw-tuned/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662284218
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/stripe/no-fpw-tuned/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662284218.804868
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=B/2CF34000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw-tuned/1000/run-ro-1/pgbench_log.tgz pgbench_log.30984 pgbench_log.30984.1 pgbench_log.30984.2 pgbench_log.30984.3
+ rm -f pgbench_log.30984 pgbench_log.30984.1 pgbench_log.30984.2 pgbench_log.30984.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662284218.804868'
+ d=900.679730
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''B/2CF34000'\'')'
+ w=8112
++ date +%s
+ t2=1662285119
++ cat 20220903/stripe/no-fpw-tuned/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=42860.875422
+ echo '1662284218;1662285119;stripe;no-fpw-tuned;1000;ro;42860.875422;900.679730;8112'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/stripe/no-fpw-tuned/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662285179
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/stripe/no-fpw-tuned/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662285179.558652
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=B/2CF36078
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/stripe/no-fpw-tuned/1000/run-rw-1/pgbench_log.tgz pgbench_log.32237 pgbench_log.32237.1 pgbench_log.32237.2 pgbench_log.32237.3
+ rm -f pgbench_log.32237 pgbench_log.32237.1 pgbench_log.32237.2 pgbench_log.32237.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662285179.558652'
+ d=3600.520113
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''B/2CF36078'\'')'
+ w=6384532824
++ date +%s
+ t2=1662288780
++ cat 20220903/stripe/no-fpw-tuned/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=6526.748315
+ echo '1662285179;1662288780;stripe;no-fpw-tuned;1000;rw;6526.748315;3600.520113;6384532824'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14888353792
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=17142338363
+ echo 'after;14888353792;2246483968;17142338363'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/stripe/no-fpw-tuned/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for level in stripe mirror raidz1 raidz2 raidz3
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/mirror/default
+ '[' -d 20220903/mirror/default ']'
+ mkdir -p 20220903/mirror/default
+ CSV='mirror;default'
+ echo '===== default mirror ====='
===== default mirror =====
+ l=mirror
+ '[' mirror == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid mirror /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-default.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/mirror/default/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/mirror/default/50
++ date +%s
+ t1=1662288844
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662288844.071477
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/18810A8
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662288844.071477'
+ d=25.756592
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/18810A8'\'')'
+ w=644061872
++ date +%s
+ t2=1662288869
+ echo '1662288844;1662288869;mirror;default;50;init;25.756592;644061872'
++ date +%s
+ t1=1662288869
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662288869.837363
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBAB58
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662288869.837363'
+ d=0.029603
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBAB58'\'')'
+ w=62632
++ date +%s
+ t2=1662288869
+ echo '1662288869;1662288869;mirror;default;50;vacuum;0.029603;62632'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/default/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662288871
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/mirror/default/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662288871.959461
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27ECA328
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/default/50/run-rw-1/pgbench_log.tgz pgbench_log.2592 pgbench_log.2592.1 pgbench_log.2592.2 pgbench_log.2592.3
+ rm -f pgbench_log.2592 pgbench_log.2592.1 pgbench_log.2592.2 pgbench_log.2592.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662288871.959461'
+ d=3600.976242
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27ECA328'\'')'
+ w=16467792048
++ date +%s
+ t2=1662292472
++ cat 20220903/mirror/default/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=14186.048045
+ echo '1662288871;1662292472;mirror;default;50;rw;14186.048045;3600.976242;16467792048'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3375431680
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3495269179
+ echo 'after;3375431680;112386048;3495269179'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/mirror/default/250
++ date +%s
+ t1=1662292533
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662292533.376615
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=3/FDBA0888
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662292533.376615'
+ d=97.656812
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''3/FDBA0888'\'')'
+ w=3220064272
++ date +%s
+ t2=1662292631
+ echo '1662292533;1662292631;mirror;default;250;init;97.656812;3220064272'
++ date +%s
+ t1=1662292631
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662292631.042882
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/BDA85098
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662292631.042882'
+ d=0.078326
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/BDA85098'\'')'
+ w=77672
++ date +%s
+ t2=1662292631
+ echo '1662292631;1662292631;mirror;default;250;vacuum;0.078326;77672'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/default/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662292631
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/mirror/default/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662292631.160505
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/BDA98000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/default/250/run-ro-1/pgbench_log.tgz pgbench_log.18937 pgbench_log.18937.1 pgbench_log.18937.2 pgbench_log.18937.3
+ rm -f pgbench_log.18937 pgbench_log.18937.1 pgbench_log.18937.2 pgbench_log.18937.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662292631.160505'
+ d=901.038265
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/BDA98000'\'')'
+ w=6960
++ date +%s
+ t2=1662293532
++ cat 20220903/mirror/default/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=69531.098861
+ echo '1662292631;1662293532;mirror;default;250;ro;69531.098861;901.038265;6960'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/default/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662293592
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/mirror/default/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662293592.267577
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/BDA99BE0
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/default/250/run-rw-1/pgbench_log.tgz pgbench_log.13624 pgbench_log.13624.1 pgbench_log.13624.2 pgbench_log.13624.3
+ rm -f pgbench_log.13624 pgbench_log.13624.1 pgbench_log.13624.2 pgbench_log.13624.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662293592.267577'
+ d=3600.517790
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/BDA99BE0'\'')'
+ w=21253474544
++ date +%s
+ t2=1662297192
++ cat 20220903/mirror/default/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=6386.204967
+ echo '1662293592;1662297192;mirror;default;250;rw;6386.204967;3600.517790;21253474544'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=4673101824
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5242254139
+ echo 'after;4673101824;561651712;5242254139'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/mirror/default/1000
++ date +%s
+ t1=1662297253
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662297253.863924
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=A/1FAEA048
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662297253.863924'
+ d=425.158682
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''A/1FAEA048'\'')'
+ w=12880077912
++ date +%s
+ t2=1662297679
+ echo '1662297253;1662297679;mirror;default;1000;init;425.158682;12880077912'
++ date +%s
+ t1=1662297679
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662297679.032380
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=D/1F6504A0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662297679.032380'
+ d=0.102910
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''D/1F6504A0'\'')'
+ w=187232
++ date +%s
+ t2=1662297679
+ echo '1662297679;1662297679;mirror;default;1000;vacuum;0.102910;187232'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/default/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662297679
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/mirror/default/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662297679.175343
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=D/1F67E000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/default/1000/run-ro-1/pgbench_log.tgz pgbench_log.26364 pgbench_log.26364.1 pgbench_log.26364.2 pgbench_log.26364.3
+ rm -f pgbench_log.26364 pgbench_log.26364.1 pgbench_log.26364.2 pgbench_log.26364.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662297679.175343'
+ d=900.655376
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''D/1F67E000'\'')'
+ w=1832
++ date +%s
+ t2=1662298579
++ cat 20220903/mirror/default/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=42413.143798
+ echo '1662297679;1662298579;mirror;default;1000;ro;42413.143798;900.655376;1832'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/default/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662298639
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/mirror/default/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662298639.908579
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=D/1F67E7D8
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/default/1000/run-rw-1/pgbench_log.tgz pgbench_log.4243 pgbench_log.4243.1 pgbench_log.4243.2 pgbench_log.4243.3
+ rm -f pgbench_log.4243 pgbench_log.4243.1 pgbench_log.4243.2 pgbench_log.4243.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662298639.908579'
+ d=3600.187944
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''D/1F67E7D8'\'')'
+ w=34904616184
++ date +%s
+ t2=1662302240
++ cat 20220903/mirror/default/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=1350.270409
+ echo '1662298639;1662302240;mirror;default;1000;rw;1350.270409;3600.187944;34904616184'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13899612160
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16153596731
+ echo 'after;13899612160;2246483968;16153596731'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/mirror/default/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/mirror/no-fpw
+ '[' -d 20220903/mirror/no-fpw ']'
+ mkdir -p 20220903/mirror/no-fpw
+ CSV='mirror;no-fpw'
+ echo '===== no-fpw mirror ====='
===== no-fpw mirror =====
+ l=mirror
+ '[' mirror == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid mirror /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/mirror/no-fpw/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/mirror/no-fpw/50
++ date +%s
+ t1=1662302304
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662302304.087748
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662302304.087748'
+ d=24.773347
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020792
++ date +%s
+ t2=1662302328
+ echo '1662302304;1662302328;mirror;no-fpw;50;init;24.773347;644020792'
++ date +%s
+ t1=1662302328
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662302328.870112
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB0770
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662302328.870112'
+ d=0.029853
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB0770'\'')'
+ w=39056
++ date +%s
+ t2=1662302328
+ echo '1662302328;1662302328;mirror;no-fpw;50;vacuum;0.029853;39056'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662302330
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/mirror/no-fpw/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662302330.591333
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBE10
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw/50/run-rw-1/pgbench_log.tgz pgbench_log.763 pgbench_log.763.1 pgbench_log.763.2 pgbench_log.763.3
+ rm -f pgbench_log.763 pgbench_log.763.1 pgbench_log.763.2 pgbench_log.763.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662302330.591333'
+ d=3600.994569
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBE10'\'')'
+ w=13483801176
++ date +%s
+ t2=1662305931
++ cat 20220903/mirror/no-fpw/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=14428.457364
+ echo '1662302330;1662305931;mirror;no-fpw;50;rw;14428.457364;3600.994569;13483801176'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3420086272
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3539915579
+ echo 'after;3420086272;112386048;3539915579'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/mirror/no-fpw/250
++ date +%s
+ t1=1662305992
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662305992.018925
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=3/4BDD1588
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662305992.018925'
+ d=95.520699
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''3/4BDD1588'\'')'
+ w=3219940992
++ date +%s
+ t2=1662306087
+ echo '1662305992;1662306087;mirror;no-fpw;250;init;95.520699;3219940992'
++ date +%s
+ t1=1662306087
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662306087.548982
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/BC97C08
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662306087.548982'
+ d=0.069272
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/BC97C08'\'')'
+ w=74744
++ date +%s
+ t2=1662306087
+ echo '1662306087;1662306087;mirror;no-fpw;250;vacuum;0.069272;74744'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662306087
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/mirror/no-fpw/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662306087.657856
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/BCAA000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw/250/run-ro-1/pgbench_log.tgz pgbench_log.14705 pgbench_log.14705.1 pgbench_log.14705.2 pgbench_log.14705.3
+ rm -f pgbench_log.14705 pgbench_log.14705.1 pgbench_log.14705.2 pgbench_log.14705.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662306087.657856'
+ d=901.029702
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/BCAA000'\'')'
+ w=1696
++ date +%s
+ t2=1662306988
++ cat 20220903/mirror/no-fpw/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=69612.076573
+ echo '1662306087;1662306988;mirror;no-fpw;250;ro;69612.076573;901.029702;1696'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662307048
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/mirror/no-fpw/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662307048.755367
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/BCAA750
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw/250/run-rw-1/pgbench_log.tgz pgbench_log.12180 pgbench_log.12180.1 pgbench_log.12180.2 pgbench_log.12180.3
+ rm -f pgbench_log.12180 pgbench_log.12180.1 pgbench_log.12180.2 pgbench_log.12180.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662307048.755367'
+ d=3600.580052
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/BCAA750'\'')'
+ w=6942623112
++ date +%s
+ t2=1662310649
++ cat 20220903/mirror/no-fpw/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=7205.478216
+ echo '1662307048;1662310649;mirror;no-fpw;250;rw;7205.478216;3600.580052;6942623112'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=4826554368
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5395706683
+ echo 'after;4826554368;561651712;5395706683'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/mirror/no-fpw/1000
++ date +%s
+ t1=1662310709
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662310709.772631
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/A9D97A20
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662310709.772631'
+ d=464.161384
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/A9D97A20'\'')'
+ w=12879642712
++ date +%s
+ t2=1662311173
+ echo '1662310709;1662311173;mirror;no-fpw;1000;init;464.161384;12879642712'
++ date +%s
+ t1=1662311173
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662311173.943476
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=8/A9893A78
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662311173.943476'
+ d=0.083605
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''8/A9893A78'\'')'
+ w=173448
++ date +%s
+ t2=1662311174
+ echo '1662311173;1662311174;mirror;no-fpw;1000;vacuum;0.083605;173448'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662311174
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/mirror/no-fpw/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662311174.067485
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=8/A98BE000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw/1000/run-ro-1/pgbench_log.tgz pgbench_log.31524 pgbench_log.31524.1 pgbench_log.31524.2 pgbench_log.31524.3
+ rm -f pgbench_log.31524 pgbench_log.31524.1 pgbench_log.31524.2 pgbench_log.31524.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662311174.067485'
+ d=900.680279
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''8/A98BE000'\'')'
+ w=7400
++ date +%s
+ t2=1662312074
++ cat 20220903/mirror/no-fpw/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=42116.553820
+ echo '1662311174;1662312074;mirror;no-fpw;1000;ro;42116.553820;900.680279;7400'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662312134
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/mirror/no-fpw/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662312134.824912
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=8/A98BFD98
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw/1000/run-rw-1/pgbench_log.tgz pgbench_log.2351 pgbench_log.2351.1 pgbench_log.2351.2 pgbench_log.2351.3
+ rm -f pgbench_log.2351 pgbench_log.2351.1 pgbench_log.2351.2 pgbench_log.2351.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662312134.824912'
+ d=3600.200680
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''8/A98BFD98'\'')'
+ w=1961602656
++ date +%s
+ t2=1662315735
++ awk '{print $3}'
++ grep 'without initial'
++ cat 20220903/mirror/no-fpw/1000/run-rw-1/pgbench.log
+ tps=1825.897442
+ echo '1662312134;1662315735;mirror;no-fpw;1000;rw;1825.897442;3600.200680;1961602656'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13996744704
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16250729275
+ echo 'after;13996744704;2246483968;16250729275'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/mirror/no-fpw/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/mirror/no-fpw-tuned
+ '[' -d 20220903/mirror/no-fpw-tuned ']'
+ mkdir -p 20220903/mirror/no-fpw-tuned
+ CSV='mirror;no-fpw-tuned'
+ echo '===== no-fpw-tuned mirror ====='
===== no-fpw-tuned mirror =====
+ l=mirror
+ '[' mirror == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid mirror /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw-tuned.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/mirror/no-fpw-tuned/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/mirror/no-fpw-tuned/50
++ date +%s
+ t1=1662315799
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662315799.069807
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662315799.069807'
+ d=17.784176
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020768
++ date +%s
+ t2=1662315816
+ echo '1662315799;1662315816;mirror;no-fpw-tuned;50;init;17.784176;644020768'
++ date +%s
+ t1=1662315816
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662315816.862407
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB0758
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662315816.862407'
+ d=0.028175
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB0758'\'')'
+ w=39080
++ date +%s
+ t2=1662315816
+ echo '1662315816;1662315816;mirror;no-fpw-tuned;50;vacuum;0.028175;39080'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw-tuned/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662315819
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/mirror/no-fpw-tuned/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662315819.221459
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBDF8
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw-tuned/50/run-rw-1/pgbench_log.tgz pgbench_log.20737 pgbench_log.20737.1 pgbench_log.20737.2 pgbench_log.20737.3
+ rm -f pgbench_log.20737 pgbench_log.20737.1 pgbench_log.20737.2 pgbench_log.20737.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662315819.221459'
+ d=3601.000853
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBDF8'\'')'
+ w=13878352008
++ date +%s
+ t2=1662319420
++ cat 20220903/mirror/no-fpw-tuned/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=14855.047023
+ echo '1662315819;1662319420;mirror;no-fpw-tuned;50;rw;14855.047023;3601.000853;13878352008'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3497312256
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3617141563
+ echo 'after;3497312256;112386048;3617141563'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/mirror/no-fpw-tuned/250
++ date +%s
+ t1=1662319480
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662319480.864796
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=3/63616DD0
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662319480.864796'
+ d=93.248509
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''3/63616DD0'\'')'
+ w=3219940952
++ date +%s
+ t2=1662319574
+ echo '1662319480;1662319574;mirror;no-fpw-tuned;250;init;93.248509;3219940952'
++ date +%s
+ t1=1662319574
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662319574.122362
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/234DD428
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662319574.122362'
+ d=0.055753
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/234DD428'\'')'
+ w=68568
++ date +%s
+ t2=1662319574
+ echo '1662319574;1662319574;mirror;no-fpw-tuned;250;vacuum;0.055753;68568'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw-tuned/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662319574
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/mirror/no-fpw-tuned/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662319574.216570
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/234EE000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw-tuned/250/run-ro-1/pgbench_log.tgz pgbench_log.20829 pgbench_log.20829.1 pgbench_log.20829.2 pgbench_log.20829.3
+ rm -f pgbench_log.20829 pgbench_log.20829.1 pgbench_log.20829.2 pgbench_log.20829.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662319574.216570'
+ d=901.046035
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/234EE000'\'')'
+ w=7904
++ date +%s
+ t2=1662320475
++ cat 20220903/mirror/no-fpw-tuned/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70152.980056
+ echo '1662319574;1662320475;mirror;no-fpw-tuned;250;ro;70152.980056;901.046035;7904'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw-tuned/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662320535
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/mirror/no-fpw-tuned/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662320535.329859
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/234EFF90
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw-tuned/250/run-rw-1/pgbench_log.tgz pgbench_log.15492 pgbench_log.15492.1 pgbench_log.15492.2 pgbench_log.15492.3
+ rm -f pgbench_log.15492 pgbench_log.15492.1 pgbench_log.15492.2 pgbench_log.15492.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662320535.329859'
+ d=3600.572641
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/234EFF90'\'')'
+ w=7108013192
++ date +%s
+ t2=1662324135
++ cat 20220903/mirror/no-fpw-tuned/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=7380.671616
+ echo '1662320535;1662324135;mirror;no-fpw-tuned;250;rw;7380.671616;3600.572641;7108013192'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=4859904000
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5429056315
+ echo 'after;4859904000;561651712;5429056315'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/mirror/no-fpw-tuned/1000
++ date +%s
+ t1=1662324196
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662324196.713852
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/CB397960
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662324196.713852'
+ d=400.608905
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/CB397960'\'')'
+ w=12879642360
++ date +%s
+ t2=1662324597
+ echo '1662324196;1662324597;mirror;no-fpw-tuned;1000;init;400.608905;12879642360'
++ date +%s
+ t1=1662324597
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662324597.331489
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=8/CAE93858
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662324597.331489'
+ d=0.103239
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''8/CAE93858'\'')'
+ w=173992
++ date +%s
+ t2=1662324597
+ echo '1662324597;1662324597;mirror;no-fpw-tuned;1000;vacuum;0.103239;173992'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw-tuned/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662324597
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/mirror/no-fpw-tuned/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662324597.473126
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=8/CAEBE000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw-tuned/1000/run-ro-1/pgbench_log.tgz pgbench_log.29053 pgbench_log.29053.1 pgbench_log.29053.2 pgbench_log.29053.3
+ rm -f pgbench_log.29053 pgbench_log.29053.1 pgbench_log.29053.2 pgbench_log.29053.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662324597.473126'
+ d=900.678818
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''8/CAEBE000'\'')'
+ w=6856
++ date +%s
+ t2=1662325498
++ cat 20220903/mirror/no-fpw-tuned/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=42213.556077
+ echo '1662324597;1662325498;mirror;no-fpw-tuned;1000;ro;42213.556077;900.678818;6856'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/mirror/no-fpw-tuned/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662325558
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/mirror/no-fpw-tuned/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662325558.229880
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=8/CAEBFB78
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/mirror/no-fpw-tuned/1000/run-rw-1/pgbench_log.tgz pgbench_log.31081 pgbench_log.31081.1 pgbench_log.31081.2 pgbench_log.31081.3
+ rm -f pgbench_log.31081 pgbench_log.31081.1 pgbench_log.31081.2 pgbench_log.31081.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662325558.229880'
+ d=3600.176927
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''8/CAEBFB78'\'')'
+ w=1919864024
++ date +%s
+ t2=1662329158
++ cat 20220903/mirror/no-fpw-tuned/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=1782.064625
+ echo '1662325558;1662329158;mirror;no-fpw-tuned;1000;rw;1782.064625;3600.176927;1919864024'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13987971072
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16241955643
+ echo 'after;13987971072;2246483968;16241955643'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/mirror/no-fpw-tuned/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for level in stripe mirror raidz1 raidz2 raidz3
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/raidz1/default
+ '[' -d 20220903/raidz1/default ']'
+ mkdir -p 20220903/raidz1/default
+ CSV='raidz1;default'
+ echo '===== default raidz1 ====='
===== default raidz1 =====
+ l=raidz1
+ '[' raidz1 == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid raidz1 /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-default.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz1/default/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/raidz1/default/50
++ date +%s
+ t1=1662329222
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662329222.290444
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/18810A8
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662329222.290444'
+ d=10.359772
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/18810A8'\'')'
+ w=644061736
++ date +%s
+ t2=1662329232
+ echo '1662329222;1662329232;raidz1;default;50;init;10.359772;644061736'
++ date +%s
+ t1=1662329232
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662329232.658734
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBAAD0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662329232.658734'
+ d=0.028788
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBAAD0'\'')'
+ w=62768
++ date +%s
+ t2=1662329232
+ echo '1662329232;1662329232;raidz1;default;50;vacuum;0.028788;62768'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/default/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662329233
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz1/default/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662329233.261292
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27ECA2A0
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/default/50/run-rw-1/pgbench_log.tgz pgbench_log.28370 pgbench_log.28370.1 pgbench_log.28370.2 pgbench_log.28370.3
+ rm -f pgbench_log.28370 pgbench_log.28370.1 pgbench_log.28370.2 pgbench_log.28370.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662329233.261292'
+ d=3601.125353
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27ECA2A0'\'')'
+ w=19345867400
++ date +%s
+ t2=1662332834
++ cat 20220903/raidz1/default/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=17317.835938
+ echo '1662329233;1662332834;raidz1;default;50;rw;17317.835938;3601.125353;19345867400'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3967508480
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=4087345979
+ echo 'after;3967508480;112386048;4087345979'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz1/default/250
++ date +%s
+ t1=1662332894
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662332894.827271
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/A94635A8
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662332894.827271'
+ d=43.667893
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/A94635A8'\'')'
+ w=3220063792
++ date +%s
+ t2=1662332938
+ echo '1662332894;1662332938;raidz1;default;250;init;43.667893;3220063792'
++ date +%s
+ t1=1662332938
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662332938.505424
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/69347BD8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662332938.505424'
+ d=0.049257
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/69347BD8'\'')'
+ w=82984
++ date +%s
+ t2=1662332938
+ echo '1662332938;1662332938;raidz1;default;250;vacuum;0.049257;82984'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/default/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662332938
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz1/default/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662332938.591513
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/6935C000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/default/250/run-ro-1/pgbench_log.tgz pgbench_log.5478 pgbench_log.5478.1 pgbench_log.5478.2 pgbench_log.5478.3
+ rm -f pgbench_log.5478 pgbench_log.5478.1 pgbench_log.5478.2 pgbench_log.5478.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662332938.591513'
+ d=901.046763
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/6935C000'\'')'
+ w=1672
++ date +%s
+ t2=1662333839
++ cat 20220903/raidz1/default/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70339.012484
+ echo '1662332938;1662333839;raidz1;default;250;ro;70339.012484;901.046763;1672'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/default/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662333899
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz1/default/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662333899.706534
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/6935C738
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/default/250/run-rw-1/pgbench_log.tgz pgbench_log.11906 pgbench_log.11906.1 pgbench_log.11906.2 pgbench_log.11906.3
+ rm -f pgbench_log.11906 pgbench_log.11906.1 pgbench_log.11906.2 pgbench_log.11906.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662333899.706534'
+ d=3600.774822
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/6935C738'\'')'
+ w=25095277336
++ date +%s
+ t2=1662337500
++ cat 20220903/raidz1/default/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=10296.576307
+ echo '1662333899;1662337500;raidz1;default;250;rw;10296.576307;3600.774822;25095277336'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=5415616512
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5984768827
+ echo 'after;5415616512;561651712;5984768827'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz1/default/1000
++ date +%s
+ t1=1662337561
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662337561.208608
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=B/41402700
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662337561.208608'
+ d=216.589749
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''B/41402700'\'')'
+ w=12880076376
++ date +%s
+ t2=1662337777
+ echo '1662337561;1662337777;raidz1;default;1000;init;216.589749;12880076376'
++ date +%s
+ t1=1662337777
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662337777.809050
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=E/40F68558
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662337777.809050'
+ d=0.134057
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''E/40F68558'\'')'
+ w=187048
++ date +%s
+ t2=1662337777
+ echo '1662337777;1662337777;raidz1;default;1000;vacuum;0.134057;187048'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/default/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662337777
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz1/default/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662337777.991601
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=E/40F96000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/default/1000/run-ro-1/pgbench_log.tgz pgbench_log.3461 pgbench_log.3461.1 pgbench_log.3461.2 pgbench_log.3461.3
+ rm -f pgbench_log.3461 pgbench_log.3461.1 pgbench_log.3461.2 pgbench_log.3461.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662337777.991601'
+ d=900.667924
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''E/40F96000'\'')'
+ w=2016
++ date +%s
+ t2=1662338678
++ cat 20220903/raidz1/default/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=41650.228016
+ echo '1662337777;1662338678;raidz1;default;1000;ro;41650.228016;900.667924;2016'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/default/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662338738
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz1/default/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662338738.735816
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=E/40F96890
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/default/1000/run-rw-1/pgbench_log.tgz pgbench_log.27499 pgbench_log.27499.1 pgbench_log.27499.2 pgbench_log.27499.3
+ rm -f pgbench_log.27499 pgbench_log.27499.1 pgbench_log.27499.2 pgbench_log.27499.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662338738.735816'
+ d=3600.303368
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''E/40F96890'\'')'
+ w=51990563456
++ date +%s
+ t2=1662342339
++ cat 20220903/raidz1/default/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=3372.345608
+ echo '1662338738;1662342339;raidz1;default;1000;rw;3372.345608;3600.303368;51990563456'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14292566016
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16546550587
+ echo 'after;14292566016;2246483968;16546550587'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz1/default/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/raidz1/no-fpw
+ '[' -d 20220903/raidz1/no-fpw ']'
+ mkdir -p 20220903/raidz1/no-fpw
+ CSV='raidz1;no-fpw'
+ echo '===== no-fpw raidz1 ====='
===== no-fpw raidz1 =====
+ l=raidz1
+ '[' raidz1 == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid raidz1 /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz1/no-fpw/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/raidz1/no-fpw/50
++ date +%s
+ t1=1662342402
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662342402.963227
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662342402.963227'
+ d=10.734603
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020656
++ date +%s
+ t2=1662342413
+ echo '1662342402;1662342413;raidz1;no-fpw;50;init;10.734603;644020656'
++ date +%s
+ t1=1662342413
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662342413.706194
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB06E8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662342413.706194'
+ d=0.028463
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB06E8'\'')'
+ w=39192
++ date +%s
+ t2=1662342413
+ echo '1662342413;1662342413;raidz1;no-fpw;50;vacuum;0.028463;39192'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662342414
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz1/no-fpw/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662342414.436206
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBD88
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw/50/run-rw-1/pgbench_log.tgz pgbench_log.9889 pgbench_log.9889.1 pgbench_log.9889.2 pgbench_log.9889.3
+ rm -f pgbench_log.9889 pgbench_log.9889.1 pgbench_log.9889.2 pgbench_log.9889.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662342414.436206'
+ d=3601.137329
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBD88'\'')'
+ w=16268821760
++ date +%s
+ t2=1662346015
++ cat 20220903/raidz1/no-fpw/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=17425.762527
+ echo '1662342414;1662346015;raidz1;no-fpw;50;rw;17425.762527;3601.137329;16268821760'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3986391040
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=4106220347
+ echo 'after;3986391040;112386048;4106220347'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz1/no-fpw/250
++ date +%s
+ t1=1662346075
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662346075.994222
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=3/F1DD19D8
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662346075.994222'
+ d=43.689834
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''3/F1DD19D8'\'')'
+ w=3219940640
++ date +%s
+ t2=1662346119
+ echo '1662346075;1662346119;raidz1;no-fpw;250;init;43.689834;3219940640'
++ date +%s
+ t1=1662346119
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662346119.695940
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/B1C97EF8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662346119.695940'
+ d=0.039834
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/B1C97EF8'\'')'
+ w=73992
++ date +%s
+ t2=1662346119
+ echo '1662346119;1662346119;raidz1;no-fpw;250;vacuum;0.039834;73992'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662346119
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz1/no-fpw/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662346119.772797
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/B1CAA000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw/250/run-ro-1/pgbench_log.tgz pgbench_log.28099 pgbench_log.28099.1 pgbench_log.28099.2 pgbench_log.28099.3
+ rm -f pgbench_log.28099 pgbench_log.28099.1 pgbench_log.28099.2 pgbench_log.28099.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662346119.772797'
+ d=901.034529
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/B1CAA000'\'')'
+ w=2448
++ date +%s
+ t2=1662347020
++ cat 20220903/raidz1/no-fpw/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70056.427517
+ echo '1662346119;1662347020;raidz1;no-fpw;250;ro;70056.427517;901.034529;2448'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662347080
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz1/no-fpw/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662347080.876580
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/B1CAAA40
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw/250/run-rw-1/pgbench_log.tgz pgbench_log.1666 pgbench_log.1666.1 pgbench_log.1666.2 pgbench_log.1666.3
+ rm -f pgbench_log.1666 pgbench_log.1666.1 pgbench_log.1666.2 pgbench_log.1666.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662347080.876580'
+ d=3600.781628
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/B1CAAA40'\'')'
+ w=10541630160
++ date +%s
+ t2=1662350681
++ cat 20220903/raidz1/no-fpw/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=11048.958447
+ echo '1662347080;1662350681;raidz1;no-fpw;250;rw;11048.958447;3600.781628;10541630160'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=5554520064
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=6123672379
+ echo 'after;5554520064;561651712;6123672379'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz1/no-fpw/1000
++ date +%s
+ t1=1662350742
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662350742.483143
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=7/265DFA58
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662350742.483143'
+ d=226.183003
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''7/265DFA58'\'')'
+ w=12879641112
++ date +%s
+ t2=1662350968
+ echo '1662350742;1662350968;raidz1;no-fpw;1000;init;226.183003;12879641112'
++ date +%s
+ t1=1662350968
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662350968.680102
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=A/260DB470
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662350968.680102'
+ d=0.116368
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''A/260DB470'\'')'
+ w=174992
++ date +%s
+ t2=1662350968
+ echo '1662350968;1662350968;raidz1;no-fpw;1000;vacuum;0.116368;174992'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662350968
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ wc -l
++ grep -v grep
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz1/no-fpw/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662350968.840327
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=A/26106000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw/1000/run-ro-1/pgbench_log.tgz pgbench_log.29572 pgbench_log.29572.1 pgbench_log.29572.2 pgbench_log.29572.3
+ rm -f pgbench_log.29572 pgbench_log.29572.1 pgbench_log.29572.2 pgbench_log.29572.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662350968.840327'
+ d=900.674030
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''A/26106000'\'')'
+ w=5856
++ date +%s
+ t2=1662351869
++ cat 20220903/raidz1/no-fpw/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=41551.293099
+ echo '1662350968;1662351869;raidz1;no-fpw;1000;ro;41551.293099;900.674030;5856'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662351929
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz1/no-fpw/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662351929.591135
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=A/26107790
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw/1000/run-rw-1/pgbench_log.tgz pgbench_log.7238 pgbench_log.7238.1 pgbench_log.7238.2 pgbench_log.7238.3
+ rm -f pgbench_log.7238 pgbench_log.7238.1 pgbench_log.7238.2 pgbench_log.7238.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662351929.591135'
+ d=3600.370917
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''A/26107790'\'')'
+ w=4242997048
++ date +%s
+ t2=1662355529
++ cat 20220903/raidz1/no-fpw/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=4248.822838
+ echo '1662351929;1662355529;raidz1;no-fpw;1000;rw;4248.822838;3600.370917;4242997048'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14458077184
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16712061755
+ echo 'after;14458077184;2246483968;16712061755'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz1/no-fpw/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/raidz1/no-fpw-tuned
+ '[' -d 20220903/raidz1/no-fpw-tuned ']'
+ mkdir -p 20220903/raidz1/no-fpw-tuned
+ CSV='raidz1;no-fpw-tuned'
+ echo '===== no-fpw-tuned raidz1 ====='
===== no-fpw-tuned raidz1 =====
+ l=raidz1
+ '[' raidz1 == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid raidz1 /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw-tuned.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz1/no-fpw-tuned/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/raidz1/no-fpw-tuned/50
++ date +%s
+ t1=1662355593
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662355593.864620
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662355593.864620'
+ d=8.742087
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020656
++ date +%s
+ t2=1662355602
+ echo '1662355593;1662355602;raidz1;no-fpw-tuned;50;init;8.742087;644020656'
++ date +%s
+ t1=1662355602
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662355602.615215
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB06E8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662355602.615215'
+ d=0.029486
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB06E8'\'')'
+ w=39192
++ date +%s
+ t2=1662355602
+ echo '1662355602;1662355602;raidz1;no-fpw-tuned;50;vacuum;0.029486;39192'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw-tuned/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662355602
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz1/no-fpw-tuned/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662355602.886502
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBD88
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw-tuned/50/run-rw-1/pgbench_log.tgz pgbench_log.2000 pgbench_log.2000.1 pgbench_log.2000.2 pgbench_log.2000.3
+ rm -f pgbench_log.2000 pgbench_log.2000.1 pgbench_log.2000.2 pgbench_log.2000.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662355602.886502'
+ d=3601.142958
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBD88'\'')'
+ w=16454806488
++ date +%s
+ t2=1662359204
++ cat 20220903/raidz1/no-fpw-tuned/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=17628.089423
+ echo '1662355602;1662359204;raidz1;no-fpw-tuned;50;rw;17628.089423;3601.142958;16454806488'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=4023345152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=4143174459
+ echo 'after;4023345152;112386048;4143174459'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz1/no-fpw-tuned/250
++ date +%s
+ t1=1662359264
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662359264.672320
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=3/FCF300B8
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662359264.672320'
+ d=42.180720
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''3/FCF300B8'\'')'
+ w=3219940584
++ date +%s
+ t2=1662359306
+ echo '1662359264;1662359306;raidz1;no-fpw-tuned;250;init;42.180720;3219940584'
++ date +%s
+ t1=1662359306
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662359306.861645
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/BCDF65A0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662359306.861645'
+ d=0.034763
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/BCDF65A0'\'')'
+ w=72288
++ date +%s
+ t2=1662359306
+ echo '1662359306;1662359306;raidz1;no-fpw-tuned;250;vacuum;0.034763;72288'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw-tuned/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662359306
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz1/no-fpw-tuned/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662359306.933744
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/BCE08000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw-tuned/250/run-ro-1/pgbench_log.tgz pgbench_log.7129 pgbench_log.7129.1 pgbench_log.7129.2 pgbench_log.7129.3
+ rm -f pgbench_log.7129 pgbench_log.7129.1 pgbench_log.7129.2 pgbench_log.7129.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662359306.933744'
+ d=901.031619
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/BCE08000'\'')'
+ w=4128
++ date +%s
+ t2=1662360207
++ cat 20220903/raidz1/no-fpw-tuned/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70673.380956
+ echo '1662359306;1662360207;raidz1;no-fpw-tuned;250;ro;70673.380956;901.031619;4128'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw-tuned/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662360268
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz1/no-fpw-tuned/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662360268.034368
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/BCE090D0
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw-tuned/250/run-rw-1/pgbench_log.tgz pgbench_log.20938 pgbench_log.20938.1 pgbench_log.20938.2 pgbench_log.20938.3
+ rm -f pgbench_log.20938 pgbench_log.20938.1 pgbench_log.20938.2 pgbench_log.20938.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662360268.034368'
+ d=3600.814240
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/BCE090D0'\'')'
+ w=10578930720
++ date +%s
+ t2=1662363868
++ cat 20220903/raidz1/no-fpw-tuned/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=11088.192697
+ echo '1662360268;1662363868;raidz1;no-fpw-tuned;250;rw;11088.192697;3600.814240;10578930720'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=5562769408
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=6131921723
+ echo 'after;5562769408;561651712;6131921723'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz1/no-fpw-tuned/1000
++ date +%s
+ t1=1662363929
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662363929.837960
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=7/33AD0A48
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662363929.837960'
+ d=207.008313
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''7/33AD0A48'\'')'
+ w=12879640928
++ date +%s
+ t2=1662364136
+ echo '1662363929;1662364136;raidz1;no-fpw-tuned;1000;init;207.008313;12879640928'
++ date +%s
+ t1=1662364136
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662364136.855134
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=A/335CC3A8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662364136.855134'
+ d=0.047578
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''A/335CC3A8'\'')'
+ w=179288
++ date +%s
+ t2=1662364136
+ echo '1662364136;1662364136;raidz1;no-fpw-tuned;1000;vacuum;0.047578;179288'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw-tuned/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662364136
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz1/no-fpw-tuned/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662364136.940608
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=A/335F8000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw-tuned/1000/run-ro-1/pgbench_log.tgz pgbench_log.27609 pgbench_log.27609.1 pgbench_log.27609.2 pgbench_log.27609.3
+ rm -f pgbench_log.27609 pgbench_log.27609.1 pgbench_log.27609.2 pgbench_log.27609.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662364136.940608'
+ d=900.667511
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''A/335F8000'\'')'
+ w=1560
++ date +%s
+ t2=1662365037
++ cat 20220903/raidz1/no-fpw-tuned/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=41818.139652
+ echo '1662364136;1662365037;raidz1;no-fpw-tuned;1000;ro;41818.139652;900.667511;1560'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz1/no-fpw-tuned/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662365097
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz1/no-fpw-tuned/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662365097.686470
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=A/335F86C8
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz1/no-fpw-tuned/1000/run-rw-1/pgbench_log.tgz pgbench_log.4335 pgbench_log.4335.1 pgbench_log.4335.2 pgbench_log.4335.3
+ rm -f pgbench_log.4335 pgbench_log.4335.1 pgbench_log.4335.2 pgbench_log.4335.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662365097.686470'
+ d=3600.363555
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''A/335F86C8'\'')'
+ w=4135054152
++ date +%s
+ t2=1662368698
++ cat 20220903/raidz1/no-fpw-tuned/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=4133.532216
+ echo '1662365097;1662368698;raidz1;no-fpw-tuned;1000;rw;4133.532216;3600.363555;4135054152'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14436048896
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16690033467
+ echo 'after;14436048896;2246483968;16690033467'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz1/no-fpw-tuned/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for level in stripe mirror raidz1 raidz2 raidz3
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/raidz2/default
+ '[' -d 20220903/raidz2/default ']'
+ mkdir -p 20220903/raidz2/default
+ CSV='raidz2;default'
+ echo '===== default raidz2 ====='
===== default raidz2 =====
+ l=raidz2
+ '[' raidz2 == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid raidz2 /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-default.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz2/default/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/raidz2/default/50
++ date +%s
+ t1=1662368762
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662368762.029066
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/18810A8
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662368762.029066'
+ d=11.552969
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/18810A8'\'')'
+ w=644061736
++ date +%s
+ t2=1662368773
+ echo '1662368762;1662368773;raidz2;default;50;init;11.552969;644061736'
++ date +%s
+ t1=1662368773
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662368773.590380
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBAAD0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662368773.590380'
+ d=0.029398
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBAAD0'\'')'
+ w=62768
++ date +%s
+ t2=1662368773
+ echo '1662368773;1662368773;raidz2;default;50;vacuum;0.029398;62768'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/default/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662368774
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz2/default/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662368774.489481
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27ECA2A0
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/default/50/run-rw-1/pgbench_log.tgz pgbench_log.17910 pgbench_log.17910.1 pgbench_log.17910.2 pgbench_log.17910.3
+ rm -f pgbench_log.17910 pgbench_log.17910.1 pgbench_log.17910.2 pgbench_log.17910.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662368774.489481'
+ d=3601.099534
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27ECA2A0'\'')'
+ w=19056331496
++ date +%s
+ t2=1662372375
++ cat 20220903/raidz2/default/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=16989.965245
+ echo '1662368774;1662372375;raidz2;default;50;rw;16989.965245;3601.099534;19056331496'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3904659456
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=4024488763
+ echo 'after;3904659456;112386048;4024488763'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz2/default/250
++ date +%s
+ t1=1662372436
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662372436.029892
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/98042B38
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662372436.029892'
+ d=45.096892
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/98042B38'\'')'
+ w=3220063928
++ date +%s
+ t2=1662372481
+ echo '1662372436;1662372481;raidz2;default;250;init;45.096892;3220063928'
++ date +%s
+ t1=1662372481
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662372481.136593
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/57F271F0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662372481.136593'
+ d=0.075353
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/57F271F0'\'')'
+ w=77328
++ date +%s
+ t2=1662372481
+ echo '1662372481;1662372481;raidz2;default;250;vacuum;0.075353;77328'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/default/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662372481
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz2/default/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662372481.252740
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/57F3A000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/default/250/run-ro-1/pgbench_log.tgz pgbench_log.32216 pgbench_log.32216.1 pgbench_log.32216.2 pgbench_log.32216.3
+ rm -f pgbench_log.32216 pgbench_log.32216.1 pgbench_log.32216.2 pgbench_log.32216.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662372481.252740'
+ d=901.060610
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/57F3A000'\'')'
+ w=7304
++ date +%s
+ t2=1662373382
++ cat 20220903/raidz2/default/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=71367.196090
+ echo '1662372481;1662373382;raidz2;default;250;ro;71367.196090;901.060610;7304'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/default/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662373442
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz2/default/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662373442.382600
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/57F3BD38
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/default/250/run-rw-1/pgbench_log.tgz pgbench_log.6312 pgbench_log.6312.1 pgbench_log.6312.2 pgbench_log.6312.3
+ rm -f pgbench_log.6312 pgbench_log.6312.1 pgbench_log.6312.2 pgbench_log.6312.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662373442.382600'
+ d=3600.778183
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/57F3BD38'\'')'
+ w=24111789552
++ date +%s
+ t2=1662377043
++ cat 20220903/raidz2/default/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=9254.623089
+ echo '1662373442;1662377043;raidz2;default;250;rw;9254.623089;3600.778183;24111789552'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=5215731712
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5784884027
+ echo 'after;5215731712;561651712;5784884027'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz2/default/1000
++ date +%s
+ t1=1662377103
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662377103.877788
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=A/F55F47D0
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662377103.877788'
+ d=225.156543
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''A/F55F47D0'\'')'
+ w=12880076512
++ date +%s
+ t2=1662377329
+ echo '1662377103;1662377329;raidz2;default;1000;init;225.156543;12880076512'
++ date +%s
+ t1=1662377329
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662377329.044634
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=D/F515A6B0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662377329.044634'
+ d=0.099749
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''D/F515A6B0'\'')'
+ w=186704
++ date +%s
+ t2=1662377329
+ echo '1662377329;1662377329;raidz2;default;1000;vacuum;0.099749;186704'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/default/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662377329
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz2/default/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662377329.186257
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=D/F5188000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/default/1000/run-ro-1/pgbench_log.tgz pgbench_log.28943 pgbench_log.28943.1 pgbench_log.28943.2 pgbench_log.28943.3
+ rm -f pgbench_log.28943 pgbench_log.28943.1 pgbench_log.28943.2 pgbench_log.28943.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662377329.186257'
+ d=900.667175
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''D/F5188000'\'')'
+ w=2360
++ date +%s
+ t2=1662378229
++ cat 20220903/raidz2/default/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=41915.396491
+ echo '1662377329;1662378229;raidz2;default;1000;ro;41915.396491;900.667175;2360'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/default/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662378289
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz2/default/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662378289.929851
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=D/F51889E8
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/default/1000/run-rw-1/pgbench_log.tgz pgbench_log.16911 pgbench_log.16911.1 pgbench_log.16911.2 pgbench_log.16911.3
+ rm -f pgbench_log.16911 pgbench_log.16911.1 pgbench_log.16911.2 pgbench_log.16911.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662378289.929851'
+ d=3600.274171
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''D/F51889E8'\'')'
+ w=49617096056
++ date +%s
+ t2=1662381890
++ cat 20220903/raidz2/default/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=2942.657650
+ echo '1662378289;1662381890;raidz2;default;1000;rw;2942.657650;3600.274171;49617096056'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14211489792
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16465474363
+ echo 'after;14211489792;2246483968;16465474363'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz2/default/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/raidz2/no-fpw
+ '[' -d 20220903/raidz2/no-fpw ']'
+ mkdir -p 20220903/raidz2/no-fpw
+ CSV='raidz2;no-fpw'
+ echo '===== no-fpw raidz2 ====='
===== no-fpw raidz2 =====
+ l=raidz2
+ '[' raidz2 == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid raidz2 /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz2/no-fpw/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/raidz2/no-fpw/50
++ date +%s
+ t1=1662381954
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662381954.145676
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662381954.145676'
+ d=11.594968
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020656
++ date +%s
+ t2=1662381965
+ echo '1662381954;1662381965;raidz2;no-fpw;50;init;11.594968;644020656'
++ date +%s
+ t1=1662381965
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662381965.749029
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB06E8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662381965.749029'
+ d=0.027999
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB06E8'\'')'
+ w=39192
++ date +%s
+ t2=1662381965
+ echo '1662381965;1662381965;raidz2;no-fpw;50;vacuum;0.027999;39192'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662381966
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz2/no-fpw/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662381966.592740
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBD88
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw/50/run-rw-1/pgbench_log.tgz pgbench_log.29980 pgbench_log.29980.1 pgbench_log.29980.2 pgbench_log.29980.3
+ rm -f pgbench_log.29980 pgbench_log.29980.1 pgbench_log.29980.2 pgbench_log.29980.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662381966.592740'
+ d=3601.120860
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBD88'\'')'
+ w=16015791736
++ date +%s
+ t2=1662385567
++ cat 20220903/raidz2/no-fpw/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=17155.067768
+ echo '1662381966;1662385567;raidz2;no-fpw;50;rw;17155.067768;3601.120860;16015791736'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3935723520
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=4055552827
+ echo 'after;3935723520;112386048;4055552827'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz2/no-fpw/250
++ date +%s
+ t1=1662385628
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662385628.140109
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=3/E2C82B28
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662385628.140109'
+ d=45.513647
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''3/E2C82B28'\'')'
+ w=3219940672
++ date +%s
+ t2=1662385673
+ echo '1662385628;1662385673;raidz2;no-fpw;250;init;45.513647;3219940672'
++ date +%s
+ t1=1662385673
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662385673.664480
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/A2B49068
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662385673.664480'
+ d=0.071598
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/A2B49068'\'')'
+ w=69528
++ date +%s
+ t2=1662385673
+ echo '1662385673;1662385673;raidz2;no-fpw;250;vacuum;0.071598;69528'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662385673
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz2/no-fpw/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662385673.779696
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/A2B5A000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw/250/run-ro-1/pgbench_log.tgz pgbench_log.4129 pgbench_log.4129.1 pgbench_log.4129.2 pgbench_log.4129.3
+ rm -f pgbench_log.4129 pgbench_log.4129.1 pgbench_log.4129.2 pgbench_log.4129.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662385673.779696'
+ d=901.044152
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/A2B5A000'\'')'
+ w=6888
++ date +%s
+ t2=1662386574
++ cat 20220903/raidz2/no-fpw/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70521.258762
+ echo '1662385673;1662386574;raidz2;no-fpw;250;ro;70521.258762;901.044152;6888'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662386634
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz2/no-fpw/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662386634.892420
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/A2B5BB98
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw/250/run-rw-1/pgbench_log.tgz pgbench_log.10612 pgbench_log.10612.1 pgbench_log.10612.2 pgbench_log.10612.3
+ rm -f pgbench_log.10612 pgbench_log.10612.1 pgbench_log.10612.2 pgbench_log.10612.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662386634.892420'
+ d=3600.736407
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/A2B5BB98'\'')'
+ w=9580792224
++ date +%s
+ t2=1662390235
++ cat 20220903/raidz2/no-fpw/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=10021.816792
+ echo '1662386634;1662390235;raidz2;no-fpw;250;rw;10021.816792;3600.736407;9580792224'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=5359648768
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5928801083
+ echo 'after;5359648768;561651712;5928801083'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz2/no-fpw/1000
++ date +%s
+ t1=1662390296
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662390296.111871
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=6/DE03D290
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662390296.111871'
+ d=246.884969
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''6/DE03D290'\'')'
+ w=12879641280
++ date +%s
+ t2=1662390543
+ echo '1662390296;1662390543;raidz2;no-fpw;1000;init;246.884969;12879641280'
++ date +%s
+ t1=1662390543
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662390543.006997
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/DDB38D50
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662390543.006997'
+ d=0.082819
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/DDB38D50'\'')'
+ w=176816
++ date +%s
+ t2=1662390543
+ echo '1662390543;1662390543;raidz2;no-fpw;1000;vacuum;0.082819;176816'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662390543
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz2/no-fpw/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662390543.132577
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/DDB64000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw/1000/run-ro-1/pgbench_log.tgz pgbench_log.21288 pgbench_log.21288.1 pgbench_log.21288.2 pgbench_log.21288.3
+ rm -f pgbench_log.21288 pgbench_log.21288.1 pgbench_log.21288.2 pgbench_log.21288.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662390543.132577'
+ d=900.643150
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/DDB64000'\'')'
+ w=4032
++ date +%s
+ t2=1662391443
++ cat 20220903/raidz2/no-fpw/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=41474.452179
+ echo '1662390543;1662391443;raidz2;no-fpw;1000;ro;41474.452179;900.643150;4032'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662391503
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz2/no-fpw/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662391503.852301
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/DDB65070
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw/1000/run-rw-1/pgbench_log.tgz pgbench_log.22910 pgbench_log.22910.1 pgbench_log.22910.2 pgbench_log.22910.3
+ rm -f pgbench_log.22910 pgbench_log.22910.1 pgbench_log.22910.2 pgbench_log.22910.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662391503.852301'
+ d=3600.356979
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/DDB65070'\'')'
+ w=3760437320
++ date +%s
+ t2=1662395104
++ cat 20220903/raidz2/no-fpw/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=3735.511197
+ echo '1662391503;1662395104;raidz2;no-fpw;1000;rw;3735.511197;3600.356979;3760437320'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14360739840
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16614724411
+ echo 'after;14360739840;2246483968;16614724411'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz2/no-fpw/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/raidz2/no-fpw-tuned
+ '[' -d 20220903/raidz2/no-fpw-tuned ']'
+ mkdir -p 20220903/raidz2/no-fpw-tuned
+ CSV='raidz2;no-fpw-tuned'
+ echo '===== no-fpw-tuned raidz2 ====='
===== no-fpw-tuned raidz2 =====
+ l=raidz2
+ '[' raidz2 == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid raidz2 /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw-tuned.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz2/no-fpw-tuned/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/raidz2/no-fpw-tuned/50
++ date +%s
+ t1=1662395168
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662395168.138956
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662395168.138956'
+ d=9.366746
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020656
++ date +%s
+ t2=1662395177
+ echo '1662395168;1662395177;raidz2;no-fpw-tuned;50;init;9.366746;644020656'
++ date +%s
+ t1=1662395177
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662395177.515352
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB06E8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662395177.515352'
+ d=0.029399
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB06E8'\'')'
+ w=39192
++ date +%s
+ t2=1662395177
+ echo '1662395177;1662395177;raidz2;no-fpw-tuned;50;vacuum;0.029399;39192'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw-tuned/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662395177
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz2/no-fpw-tuned/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662395177.818256
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBD88
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw-tuned/50/run-rw-1/pgbench_log.tgz pgbench_log.3022 pgbench_log.3022.1 pgbench_log.3022.2 pgbench_log.3022.3
+ rm -f pgbench_log.3022 pgbench_log.3022.1 pgbench_log.3022.2 pgbench_log.3022.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662395177.818256'
+ d=3601.127606
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBD88'\'')'
+ w=16040120352
++ date +%s
+ t2=1662398778
++ cat 20220903/raidz2/no-fpw-tuned/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=17181.691556
+ echo '1662395177;1662398778;raidz2;no-fpw-tuned;50;rw;17181.691556;3601.127606;16040120352'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3937271808
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=4057101115
+ echo 'after;3937271808;112386048;4057101115'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz2/no-fpw-tuned/250
++ date +%s
+ t1=1662398839
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662398839.750892
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=3/E43B64D8
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662398839.750892'
+ d=44.010110
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''3/E43B64D8'\'')'
+ w=3219940640
++ date +%s
+ t2=1662398883
+ echo '1662398839;1662398883;raidz2;no-fpw-tuned;250;init;44.010110;3219940640'
++ date +%s
+ t1=1662398883
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662398883.771072
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/A427C9F8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662398883.771072'
+ d=0.073725
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/A427C9F8'\'')'
+ w=71176
++ date +%s
+ t2=1662398883
+ echo '1662398883;1662398883;raidz2;no-fpw-tuned;250;vacuum;0.073725;71176'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw-tuned/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662398883
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ grep -v grep
++ ps ax
++ grep collect-stats
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
++ psql -t -A test -c 'select extract(epoch from now())'
+ ./collect-stats.sh 900 20220903/raidz2/no-fpw-tuned/250/run-ro-1
+ s=1662398883.891593
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/A428E000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw-tuned/250/run-ro-1/pgbench_log.tgz pgbench_log.16398 pgbench_log.16398.1 pgbench_log.16398.2 pgbench_log.16398.3
+ rm -f pgbench_log.16398 pgbench_log.16398.1 pgbench_log.16398.2 pgbench_log.16398.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662398883.891593'
+ d=901.044169
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/A428E000'\'')'
+ w=5240
++ date +%s
+ t2=1662399784
++ cat 20220903/raidz2/no-fpw-tuned/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70145.458436
+ echo '1662398883;1662399784;raidz2;no-fpw-tuned;250;ro;70145.458436;901.044169;5240'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw-tuned/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662399844
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz2/no-fpw-tuned/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662399845.004106
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/A428F528
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw-tuned/250/run-rw-1/pgbench_log.tgz pgbench_log.32414 pgbench_log.32414.1 pgbench_log.32414.2 pgbench_log.32414.3
+ rm -f pgbench_log.32414 pgbench_log.32414.1 pgbench_log.32414.2 pgbench_log.32414.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662399845.004106'
+ d=3600.734963
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/A428F528'\'')'
+ w=9630378552
++ date +%s
+ t2=1662403445
++ cat 20220903/raidz2/no-fpw-tuned/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=10075.941535
+ echo '1662399844;1662403445;raidz2;no-fpw-tuned;250;rw;10075.941535;3600.734963;9630378552'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=5368463360
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5937615675
+ echo 'after;5368463360;561651712;5937615675'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz2/no-fpw-tuned/1000
++ date +%s
+ t1=1662403506
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662403506.753058
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=6/E26BBDE0
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662403506.753058'
+ d=218.986171
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''6/E26BBDE0'\'')'
+ w=12879641048
++ date +%s
+ t2=1662403725
+ echo '1662403506;1662403725;raidz2;no-fpw-tuned;1000;init;218.986171;12879641048'
++ date +%s
+ t1=1662403725
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662403725.749257
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/E21B77B8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662403725.749257'
+ d=0.087566
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/E21B77B8'\'')'
+ w=174152
++ date +%s
+ t2=1662403725
+ echo '1662403725;1662403725;raidz2;no-fpw-tuned;1000;vacuum;0.087566;174152'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw-tuned/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662403725
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz2/no-fpw-tuned/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662403725.879933
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/E21E2000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw-tuned/1000/run-ro-1/pgbench_log.tgz pgbench_log.5879 pgbench_log.5879.1 pgbench_log.5879.2 pgbench_log.5879.3
+ rm -f pgbench_log.5879 pgbench_log.5879.1 pgbench_log.5879.2 pgbench_log.5879.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662403725.879933'
+ d=900.675649
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/E21E2000'\'')'
+ w=6696
++ date +%s
+ t2=1662404626
++ cat 20220903/raidz2/no-fpw-tuned/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=41527.675228
+ echo '1662403725;1662404626;raidz2;no-fpw-tuned;1000;ro;41527.675228;900.675649;6696'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz2/no-fpw-tuned/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662404686
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz2/no-fpw-tuned/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662404686.632299
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/E21E3AD8
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz2/no-fpw-tuned/1000/run-rw-1/pgbench_log.tgz pgbench_log.399 pgbench_log.399.1 pgbench_log.399.2 pgbench_log.399.3
+ rm -f pgbench_log.399 pgbench_log.399.1 pgbench_log.399.2 pgbench_log.399.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662404686.632299'
+ d=3600.306201
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/E21E3AD8'\'')'
+ w=3639008440
++ date +%s
+ t2=1662408286
++ cat 20220903/raidz2/no-fpw-tuned/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=3606.457647
+ echo '1662404686;1662408286;raidz2;no-fpw-tuned;1000;rw;3606.457647;3600.306201;3639008440'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14336712704
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16590697275
+ echo 'after;14336712704;2246483968;16590697275'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz2/no-fpw-tuned/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for level in stripe mirror raidz1 raidz2 raidz3
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/raidz3/default
+ '[' -d 20220903/raidz3/default ']'
+ mkdir -p 20220903/raidz3/default
+ CSV='raidz3;default'
+ echo '===== default raidz3 ====='
===== default raidz3 =====
+ l=raidz3
+ '[' raidz3 == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid raidz3 /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-default.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz3/default/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/raidz3/default/50
++ date +%s
+ t1=1662408350
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662408350.915813
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/18810A8
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662408350.915813'
+ d=12.785496
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/18810A8'\'')'
+ w=644061736
++ date +%s
+ t2=1662408363
+ echo '1662408350;1662408363;raidz3;default;50;init;12.785496;644061736'
++ date +%s
+ t1=1662408363
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662408363.709578
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBAAD0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662408363.709578'
+ d=0.028704
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBAAD0'\'')'
+ w=62768
++ date +%s
+ t2=1662408363
+ echo '1662408363;1662408363;raidz3;default;50;vacuum;0.028704;62768'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/default/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662408364
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz3/default/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662408364.831633
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27ECA2A0
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/default/50/run-rw-1/pgbench_log.tgz pgbench_log.6432 pgbench_log.6432.1 pgbench_log.6432.2 pgbench_log.6432.3
+ rm -f pgbench_log.6432 pgbench_log.6432.1 pgbench_log.6432.2 pgbench_log.6432.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662408364.831633'
+ d=3601.045752
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27ECA2A0'\'')'
+ w=17852753096
++ date +%s
+ t2=1662411965
++ cat 20220903/raidz3/default/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=15778.771638
+ echo '1662408364;1662411965;raidz3;default;50;rw;15778.771638;3601.045752;17852753096'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3675971584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3795800891
+ echo 'after;3675971584;112386048;3795800891'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz3/default/250
++ date +%s
+ t1=1662412026
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662412026.339683
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/50470548
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662412026.339683'
+ d=52.226122
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/50470548'\'')'
+ w=3220063864
++ date +%s
+ t2=1662412078
+ echo '1662412026;1662412078;raidz3;default;250;init;52.226122;3220063864'
++ date +%s
+ t1=1662412078
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662412078.574839
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/10354BC0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662412078.574839'
+ d=0.102486
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/10354BC0'\'')'
+ w=78912
++ date +%s
+ t2=1662412078
+ echo '1662412078;1662412078;raidz3;default;250;vacuum;0.102486;78912'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/default/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662412078
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz3/default/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662412078.720237
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/10368000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/default/250/run-ro-1/pgbench_log.tgz pgbench_log.10616 pgbench_log.10616.1 pgbench_log.10616.2 pgbench_log.10616.3
+ rm -f pgbench_log.10616 pgbench_log.10616.1 pgbench_log.10616.2 pgbench_log.10616.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662412078.720237'
+ d=901.047724
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/10368000'\'')'
+ w=5776
++ date +%s
+ t2=1662412979
++ cat 20220903/raidz3/default/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70126.174518
+ echo '1662412078;1662412979;raidz3;default;250;ro;70126.174518;901.047724;5776'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/default/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662413039
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz3/default/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662413039.836407
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=5/10369740
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/default/250/run-rw-1/pgbench_log.tgz pgbench_log.20685 pgbench_log.20685.1 pgbench_log.20685.2 pgbench_log.20685.3
+ rm -f pgbench_log.20685 pgbench_log.20685.1 pgbench_log.20685.2 pgbench_log.20685.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662413039.836407'
+ d=3600.640067
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''5/10369740'\'')'
+ w=23223410056
++ date +%s
+ t2=1662416640
++ cat 20220903/raidz3/default/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=8109.073982
+ echo '1662413039;1662416640;raidz3;default;250;rw;8109.073982;3600.640067;23223410056'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=4998733824
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5567886139
+ echo 'after;4998733824;561651712;5567886139'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz3/default/1000
++ date +%s
+ t1=1662416701
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662416701.422327
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=A/78AE8970
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662416701.422327'
+ d=252.562064
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''A/78AE8970'\'')'
+ w=12880076696
++ date +%s
+ t2=1662416953
+ echo '1662416701;1662416953;raidz3;default;1000;init;252.562064;12880076696'
++ date +%s
+ t1=1662416953
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662416953.994240
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=D/7864E908
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662416953.994240'
+ d=0.129656
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''D/7864E908'\'')'
+ w=186104
++ date +%s
+ t2=1662416954
+ echo '1662416953;1662416954;raidz3;default;1000;vacuum;0.129656;186104'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/default/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662416954
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep -v grep
++ grep collect-stats
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz3/default/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662416954.168153
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=D/7867C000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/default/1000/run-ro-1/pgbench_log.tgz pgbench_log.4051 pgbench_log.4051.1 pgbench_log.4051.2 pgbench_log.4051.3
+ rm -f pgbench_log.4051 pgbench_log.4051.1 pgbench_log.4051.2 pgbench_log.4051.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662416954.168153'
+ d=900.657408
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''D/7867C000'\'')'
+ w=3016
++ date +%s
+ t2=1662417854
++ cat 20220903/raidz3/default/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=41366.511400
+ echo '1662416954;1662417854;raidz3;default;1000;ro;41366.511400;900.657408;3016'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/default/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662417914
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz3/default/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662417914.902362
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=D/7867CC78
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/default/1000/run-rw-1/pgbench_log.tgz pgbench_log.25642 pgbench_log.25642.1 pgbench_log.25642.2 pgbench_log.25642.3
+ rm -f pgbench_log.25642 pgbench_log.25642.1 pgbench_log.25642.2 pgbench_log.25642.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662417914.902362'
+ d=3600.238653
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''D/7867CC78'\'')'
+ w=46255775072
++ date +%s
+ t2=1662421515
++ cat 20220903/raidz3/default/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=2450.165588
+ echo '1662417914;1662421515;raidz3;default;1000;rw;2450.165588;3600.238653;46255775072'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14117502976
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16371487547
+ echo 'after;14117502976;2246483968;16371487547'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz3/default/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/raidz3/no-fpw
+ '[' -d 20220903/raidz3/no-fpw ']'
+ mkdir -p 20220903/raidz3/no-fpw
+ CSV='raidz3;no-fpw'
+ echo '===== no-fpw raidz3 ====='
===== no-fpw raidz3 =====
+ l=raidz3
+ '[' raidz3 == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid raidz3 /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz3/no-fpw/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/raidz3/no-fpw/50
++ date +%s
+ t1=1662421579
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662421579.098352
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662421579.098352'
+ d=13.008937
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020656
++ date +%s
+ t2=1662421592
+ echo '1662421579;1662421592;raidz3;no-fpw;50;init;13.008937;644020656'
++ date +%s
+ t1=1662421592
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662421592.115750
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB06E8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662421592.115750'
+ d=0.029325
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB06E8'\'')'
+ w=39192
++ date +%s
+ t2=1662421592
+ echo '1662421592;1662421592;raidz3;no-fpw;50;vacuum;0.029325;39192'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662421593
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz3/no-fpw/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662421593.299876
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBD88
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw/50/run-rw-1/pgbench_log.tgz pgbench_log.4879 pgbench_log.4879.1 pgbench_log.4879.2 pgbench_log.4879.3
+ rm -f pgbench_log.4879 pgbench_log.4879.1 pgbench_log.4879.2 pgbench_log.4879.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662421593.299876'
+ d=3601.072238
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBD88'\'')'
+ w=15155190496
++ date +%s
+ t2=1662425194
++ cat 20220903/raidz3/no-fpw/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=16228.391258
+ echo '1662421593;1662425194;raidz3;no-fpw;50;rw;16228.391258;3601.072238;15155190496'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3760185344
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3880014651
+ echo 'after;3760185344;112386048;3880014651'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz3/no-fpw/250
++ date +%s
+ t1=1662425254
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662425254.792395
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=3/AF7C6F90
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662425254.792395'
+ d=52.401743
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''3/AF7C6F90'\'')'
+ w=3219940680
++ date +%s
+ t2=1662425307
+ echo '1662425254;1662425307;raidz3;no-fpw;250;init;52.401743;3219940680'
++ date +%s
+ t1=1662425307
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662425307.203668
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/6F68D4D8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662425307.203668'
+ d=0.092402
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/6F68D4D8'\'')'
+ w=68392
++ date +%s
+ t2=1662425307
+ echo '1662425307;1662425307;raidz3;no-fpw;250;vacuum;0.092402;68392'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662425307
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz3/no-fpw/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662425307.340223
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/6F69E000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw/250/run-ro-1/pgbench_log.tgz pgbench_log.29441 pgbench_log.29441.1 pgbench_log.29441.2 pgbench_log.29441.3
+ rm -f pgbench_log.29441 pgbench_log.29441.1 pgbench_log.29441.2 pgbench_log.29441.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662425307.340223'
+ d=901.057146
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/6F69E000'\'')'
+ w=8080
++ date +%s
+ t2=1662426208
++ cat 20220903/raidz3/no-fpw/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=71191.883942
+ echo '1662425307;1662426208;raidz3;no-fpw;250;ro;71191.883942;901.057146;8080'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662426268
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz3/no-fpw/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662426268.466531
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/6F6A0058
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw/250/run-rw-1/pgbench_log.tgz pgbench_log.7650 pgbench_log.7650.1 pgbench_log.7650.2 pgbench_log.7650.3
+ rm -f pgbench_log.7650 pgbench_log.7650.1 pgbench_log.7650.2 pgbench_log.7650.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662426268.466531'
+ d=3600.672126
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/6F6A0058'\'')'
+ w=8529002800
++ date +%s
+ t2=1662429869
++ cat 20220903/raidz3/no-fpw/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=8895.950274
+ echo '1662426268;1662429869;raidz3;no-fpw;250;rw;8895.950274;3600.672126;8529002800'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=5147000832
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5716153147
+ echo 'after;5147000832;561651712;5716153147'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz3/no-fpw/1000
++ date +%s
+ t1=1662429929
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662429929.803119
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=6/6C070ED8
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662429929.803119'
+ d=272.941026
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''6/6C070ED8'\'')'
+ w=12879641368
++ date +%s
+ t2=1662430202
+ echo '1662429929;1662430202;raidz3;no-fpw;1000;init;272.941026;12879641368'
++ date +%s
+ t1=1662430202
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662430202.753910
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/6BB6C9F0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662430202.753910'
+ d=0.097186
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/6BB6C9F0'\'')'
+ w=177680
++ date +%s
+ t2=1662430202
+ echo '1662430202;1662430202;raidz3;no-fpw;1000;vacuum;0.097186;177680'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662430202
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz3/no-fpw/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662430202.894275
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/6BB98000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw/1000/run-ro-1/pgbench_log.tgz pgbench_log.12346 pgbench_log.12346.1 pgbench_log.12346.2 pgbench_log.12346.3
+ rm -f pgbench_log.12346 pgbench_log.12346.1 pgbench_log.12346.2 pgbench_log.12346.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662430202.894275'
+ d=900.660584
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/6BB98000'\'')'
+ w=3168
++ date +%s
+ t2=1662431103
++ cat 20220903/raidz3/no-fpw/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=41473.705210
+ echo '1662430202;1662431103;raidz3;no-fpw;1000;ro;41473.705210;900.660584;3168'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662431163
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz3/no-fpw/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662431163.633286
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/6BB98D10
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw/1000/run-rw-1/pgbench_log.tgz pgbench_log.21859 pgbench_log.21859.1 pgbench_log.21859.2 pgbench_log.21859.3
+ rm -f pgbench_log.21859 pgbench_log.21859.1 pgbench_log.21859.2 pgbench_log.21859.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662431163.633286'
+ d=3600.297498
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/6BB98D10'\'')'
+ w=3267758208
++ date +%s
+ t2=1662434763
++ cat 20220903/raidz3/no-fpw/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=3211.319465
+ echo '1662431163;1662434763;raidz3;no-fpw;1000;rw;3211.319465;3600.297498;3267758208'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14262239232
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16516223803
+ echo 'after;14262239232;2246483968;16516223803'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz3/no-fpw/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
+ for pgconf in default no-fpw no-fpw-tuned
+ TESTDIR=20220903/raidz3/no-fpw-tuned
+ '[' -d 20220903/raidz3/no-fpw-tuned ']'
+ mkdir -p 20220903/raidz3/no-fpw-tuned
+ CSV='raidz3;no-fpw-tuned'
+ echo '===== no-fpw-tuned raidz3 ====='
===== no-fpw-tuned raidz3 =====
+ l=raidz3
+ '[' raidz3 == stripe ']'
+ sudo zpool create -o ashift=12 -R /mnt zfs_raid raidz3 /dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sde /dev/sdf
+ sudo zfs set recordsize=8K compression=lz4 atime=off relatime=on logbias=latency redundant_metadata=most zfs_raid
+ sudo zfs create zfs_raid/pg
+ sudo chown postgres:postgres /mnt/zfs_raid/pg
+ sudo zfs get all zfs_raid/pg
+ sudo zpool status zfs_raid
+ pg_ctl -D /mnt/zfs_raid/pg/data init
+ cp postgresql-no-fpw-tuned.conf /mnt/zfs_raid/pg/data/postgresql.conf
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz3/no-fpw-tuned/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 50 250 1000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220903/raidz3/no-fpw-tuned/50
++ date +%s
+ t1=1662434827
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662434827.910037
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/1880D38
+ pgbench -i -s 50 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662434827.910037'
+ d=10.813980
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/1880D38'\'')'
+ w=644020656
++ date +%s
+ t2=1662434838
+ echo '1662434827;1662434838;raidz3;no-fpw-tuned;50;init;10.813980;644020656'
++ date +%s
+ t1=1662434838
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662434838.733798
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EB06E8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662434838.733798'
+ d=0.031039
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EB06E8'\'')'
+ w=39192
++ date +%s
+ t2=1662434838
+ echo '1662434838;1662434838;raidz3;no-fpw-tuned;50;vacuum;0.031039;39192'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 50 == 50 ']'
+ continue
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw-tuned/50/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662434839
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=671793152
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=791614267
+ echo 'before;671793152;112386048;791614267'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz3/no-fpw-tuned/50/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662434839.273156
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/27EBBD88
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw-tuned/50/run-rw-1/pgbench_log.tgz pgbench_log.13651 pgbench_log.13651.1 pgbench_log.13651.2 pgbench_log.13651.3
+ rm -f pgbench_log.13651 pgbench_log.13651.1 pgbench_log.13651.2 pgbench_log.13651.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662434839.273156'
+ d=3601.088595
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/27EBBD88'\'')'
+ w=15413703784
++ date +%s
+ t2=1662438440
++ cat 20220903/raidz3/no-fpw-tuned/50/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=16507.997270
+ echo '1662434839;1662438440;raidz3;no-fpw-tuned;50;rw;16507.997270;3601.088595;15413703784'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3809484800
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=112386048
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3929314107
+ echo 'after;3809484800;112386048;3929314107'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz3/no-fpw-tuned/250
++ date +%s
+ t1=1662438501
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662438501.187933
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=3/BEE50920
+ pgbench -i -s 250 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662438501.187933'
+ d=50.833824
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''3/BEE50920'\'')'
+ w=3219940736
++ date +%s
+ t2=1662438552
+ echo '1662438501;1662438552;raidz3;no-fpw-tuned;250;init;50.833824;3219940736'
++ date +%s
+ t1=1662438552
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662438552.032730
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/7ED16EA0
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662438552.032730'
+ d=0.099745
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/7ED16EA0'\'')'
+ w=69984
++ date +%s
+ t2=1662438552
+ echo '1662438552;1662438552;raidz3;no-fpw-tuned;250;vacuum;0.099745;69984'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 250 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw-tuned/250/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662438552
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz3/no-fpw-tuned/250/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662438552.176973
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/7ED28000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw-tuned/250/run-ro-1/pgbench_log.tgz pgbench_log.29396 pgbench_log.29396.1 pgbench_log.29396.2 pgbench_log.29396.3
+ rm -f pgbench_log.29396 pgbench_log.29396.1 pgbench_log.29396.2 pgbench_log.29396.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662438552.176973'
+ d=901.046476
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/7ED28000'\'')'
+ w=6488
++ date +%s
+ t2=1662439453
++ cat 20220903/raidz3/no-fpw-tuned/250/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=70716.723735
+ echo '1662438552;1662439453;raidz3;no-fpw-tuned;250;ro;70716.723735;901.046476;6488'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'after;3358531584;561651712;3927683899'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw-tuned/250/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662439513
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=3358531584
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=3927683899
+ echo 'before;3358531584;561651712;3927683899'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz3/no-fpw-tuned/250/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662439513.292226
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=4/7ED29A08
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw-tuned/250/run-rw-1/pgbench_log.tgz pgbench_log.20928 pgbench_log.20928.1 pgbench_log.20928.2 pgbench_log.20928.3
+ rm -f pgbench_log.20928 pgbench_log.20928.1 pgbench_log.20928.2 pgbench_log.20928.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662439513.292226'
+ d=3600.661544
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''4/7ED29A08'\'')'
+ w=8621474176
++ date +%s
+ t2=1662443113
++ cat 20220903/raidz3/no-fpw-tuned/250/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=8994.644574
+ echo '1662439513;1662443113;raidz3;no-fpw-tuned;250;rw;8994.644574;3600.661544;8621474176'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=5165498368
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=561651712
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=5734650683
+ echo 'after;5165498368;561651712;5734650683'
+ sudo zpool status zfs_raid
+ sleep 60
+ for scale in 50 250 1000
+ dropdb --if-exists test
+ createdb test
+ mkdir 20220903/raidz3/no-fpw-tuned/1000
++ date +%s
+ t1=1662443174
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662443174.766596
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=6/80F2A8E8
+ pgbench -i -s 1000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662443174.766596'
+ d=237.557701
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''6/80F2A8E8'\'')'
+ w=12879641112
++ date +%s
+ t2=1662443412
+ echo '1662443174;1662443412;raidz3;no-fpw-tuned;1000;init;237.557701;12879641112'
++ date +%s
+ t1=1662443412
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662443412.338285
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/80A26300
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1662443412.338285'
+ d=0.146583
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/80A26300'\'')'
+ w=179456
++ date +%s
+ t2=1662443412
+ echo '1662443412;1662443412;raidz3;no-fpw-tuned;1000;vacuum;0.146583;179456'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 1000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw-tuned/1000/run-ro-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662443412
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep -v grep
++ wc -l
++ grep collect-stats
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220903/raidz3/no-fpw-tuned/1000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662443412.537907
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/80A52000
+ pgbench -n -M prepared -S -j 4 -c 16 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw-tuned/1000/run-ro-1/pgbench_log.tgz pgbench_log.31873 pgbench_log.31873.1 pgbench_log.31873.2 pgbench_log.31873.3
+ rm -f pgbench_log.31873 pgbench_log.31873.1 pgbench_log.31873.2 pgbench_log.31873.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662443412.537907'
+ d=900.677120
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/80A52000'\'')'
+ w=1392
++ date +%s
+ t2=1662444313
++ cat 20220903/raidz3/no-fpw-tuned/1000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=41402.272263
+ echo '1662443412;1662444313;raidz3;no-fpw-tuned;1000;ro;41402.272263;900.677120;1392'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'after;13433806848;2246483968;15687791419'
+ sudo zpool status zfs_raid
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220903/raidz3/no-fpw-tuned/1000/run-rw-1
+ sudo zpool status zfs_raid
++ date +%s
+ t1=1662444373
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=13433806848
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=15687791419
+ echo 'before;13433806848;2246483968;15687791419'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220903/raidz3/no-fpw-tuned/1000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1662444373.291416
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=9/80A52620
+ pgbench -n -M prepared -N -j 4 -c 16 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220903/raidz3/no-fpw-tuned/1000/run-rw-1/pgbench_log.tgz pgbench_log.32502 pgbench_log.32502.1 pgbench_log.32502.2 pgbench_log.32502.3
+ rm -f pgbench_log.32502 pgbench_log.32502.1 pgbench_log.32502.2 pgbench_log.32502.3
++ psql -t -A test -c 'select extract(epoch from now()) - 1662444373.291416'
+ d=3600.343277
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''9/80A52620'\'')'
+ w=3166543520
++ date +%s
+ t2=1662447973
++ cat 20220903/raidz3/no-fpw-tuned/1000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=3103.656038
+ echo '1662444373;1662447973;raidz3;no-fpw-tuned;1000;rw;3103.656038;3600.343277;3166543520'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=14242021376
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=2246483968
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=16496005947
+ echo 'after;14242021376;2246483968;16496005947'
+ sudo zpool status zfs_raid
+ sleep 60
+ pg_ctl -D /mnt/zfs_raid/pg/data -l 20220903/raidz3/no-fpw-tuned/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo zpool status zfs_raid
+ sudo zpool destroy zfs_raid
