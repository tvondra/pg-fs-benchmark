+ set -e
+ LOG_DIR=20220912-btrfs-limit
+ JOBS=8
+ CLIENTS=32
+ DURATION_RO=900
+ DURATION_RW=3600
+ RUNS_RO=1
+ RUNS_RW=1
+ MOUNTDIR=/mnt/data
+ DATADIR=/mnt/data/pgdata
+ for level in stripe
+ for pgconf in default
+ TESTDIR=20220912-btrfs-limit/stripe/default
+ '[' -d 20220912-btrfs-limit/stripe/default ']'
+ mkdir -p 20220912-btrfs-limit/stripe/default
+ CSV='stripe;default'
+ rate=5000
+ limit=12
+ echo '===== default stripe 5000 12 ====='
===== default stripe 5000 12 =====
+ l=stripe
+ '[' stripe == stripe ']'
+ l=
+ sudo mkfs.btrfs -f -L data /dev/nvme0n1p1
+ sleep 5
+ sudo mount -o ssd,relatime /dev/disk/by-label/data /mnt/data
+ sudo chown postgres:postgres /mnt/data
+ pg_ctl -D /mnt/data/pgdata init
+ cp postgresql-default.conf /mnt/data/pgdata/postgresql.conf
+ pg_ctl -D /mnt/data/pgdata -l 20220912-btrfs-limit/stripe/default/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ for scale in 10000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220912-btrfs-limit/stripe/default/10000
++ date +%s
+ t1=1663008437
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663008437.578735
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/18810A8
+ pgbench -i -s 10000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1663008437.578735'
+ d=1687.503222
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/18810A8'\'')'
+ w=128800548336
++ date +%s
+ t2=1663010125
+ echo '1663008437;1663010125;stripe;default;10000;init;1687.503222;128800548336'
++ date +%s
+ t1=1663010125
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663010125.099938
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=1D/FEA47698
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1663010125.099938'
+ d=0.199706
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''1D/FEA47698'\'')'
+ w=5056872
++ date +%s
+ t2=1663010125
+ echo '1663010125;1663010125;stripe;default;10000;vacuum;0.199706;5056872'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 10000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220912-btrfs-limit/stripe/default/10000/run-ro-1
+ sudo btrfs filesystem show
+ sudo btrfs filesystem df /mnt/data
+ sudo btrfs filesystem usage /mnt/data
++ date +%s
+ t1=1663010125
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=134337085440
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=156808655675
+ echo 'before;134337085440;22464135168;156808655675'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220912-btrfs-limit/stripe/default/10000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663010125.538236
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=1D/FEF1A000
+ pgbench -n -M prepared -S -j 8 -c 32 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220912-btrfs-limit/stripe/default/10000/run-ro-1/pgbench_log.tgz pgbench_log.22029 pgbench_log.22029.1 pgbench_log.22029.2 pgbench_log.22029.3 pgbench_log.22029.4 pgbench_log.22029.5 pgbench_log.22029.6 pgbench_log.22029.7
+ rm -f pgbench_log.22029 pgbench_log.22029.1 pgbench_log.22029.2 pgbench_log.22029.3 pgbench_log.22029.4 pgbench_log.22029.5 pgbench_log.22029.6 pgbench_log.22029.7
++ psql -t -A test -c 'select extract(epoch from now()) - 1663010125.538236'
+ d=903.114020
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''1D/FEF1A000'\'')'
+ w=2248
++ date +%s
+ t2=1663011028
++ cat 20220912-btrfs-limit/stripe/default/10000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=126668.359107
+ echo '1663010125;1663011028;stripe;default;10000;ro;126668.359107;903.114020;2248'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=134337085440
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=156808655675
+ echo 'after;134337085440;22464135168;156808655675'
+ sudo btrfs filesystem show
+ sudo btrfs filesystem df /mnt/data
+ sudo btrfs filesystem usage /mnt/data
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220912-btrfs-limit/stripe/default/10000/run-rw-1
+ sudo btrfs filesystem show
+ sudo btrfs filesystem df /mnt/data
+ sudo btrfs filesystem usage /mnt/data
++ date +%s
+ t1=1663011089
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=134337085440
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=156808655675
+ echo 'before;134337085440;22464135168;156808655675'
++ ps ax
++ grep collect-stats
++ wc -l
++ grep -v grep
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220912-btrfs-limit/stripe/default/10000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663011089.066139
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=1D/FEF1A9B0
+ pgbench -n -M prepared -N -R 5000 -L 12 -j 8 -c 32 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220912-btrfs-limit/stripe/default/10000/run-rw-1/pgbench_log.tgz pgbench_log.27614 pgbench_log.27614.1 pgbench_log.27614.2 pgbench_log.27614.3 pgbench_log.27614.4 pgbench_log.27614.5 pgbench_log.27614.6 pgbench_log.27614.7
+ rm -f pgbench_log.27614 pgbench_log.27614.1 pgbench_log.27614.2 pgbench_log.27614.3 pgbench_log.27614.4 pgbench_log.27614.5 pgbench_log.27614.6 pgbench_log.27614.7
++ psql -t -A test -c 'select extract(epoch from now()) - 1663011089.066139'
+ d=3600.834392
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''1D/FEF1A9B0'\'')'
+ w=146573937560
++ date +%s
+ t2=1663014690
++ cat 20220912-btrfs-limit/stripe/default/10000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=3634.044504
+ echo '1663011089;1663014690;stripe;default;10000;rw;3634.044504;3600.834392;146573937560'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=136237604864
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=158709183291
+ echo 'after;136237604864;22464135168;158709183291'
+ sudo btrfs filesystem show
+ sudo btrfs filesystem df /mnt/data
+ sudo btrfs filesystem usage /mnt/data
+ sleep 60
+ pg_ctl -D /mnt/data/pgdata -l 20220912-btrfs-limit/stripe/default/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down..... done
server stopped
+ sudo umount /mnt/data
