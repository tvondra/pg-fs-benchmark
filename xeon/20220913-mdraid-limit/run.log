+ set -e
+ LOG_DIR=20220913-mdraid-limit
+ JOBS=8
+ CLIENTS=32
+ DURATION_RO=900
+ DURATION_RW=3600
+ RUNS_RO=1
+ RUNS_RW=1
+ MOUNTDIR=/mnt/data
+ DATADIR=/mnt/data/pgdata
+ for level in 0
+ pgconf=default
+ for fs in xfs ext4
+ TESTDIR=20220913-mdraid-limit/0/xfs
+ '[' -d 20220913-mdraid-limit/0/xfs ']'
+ mkdir -p 20220913-mdraid-limit/0/xfs
+ rate=10000
+ limit=6
+ CSV='0;default;xfs'
+ echo '===== default 0 xfs 10000 6 ====='
===== default 0 xfs 10000 6 =====
+ '[' xfs == ext4 ']'
+ sudo mkfs.xfs -f /dev/nvme0n1p1
meta-data=/dev/nvme0n1p1         isize=512    agcount=4, agsize=58605718 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=0 inobtcount=0
data     =                       bsize=4096   blocks=234422870, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=114464, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
Discarding blocks...Done.
+ sleep 5
+ sudo mount -o relatime /dev/nvme0n1p1 /mnt/data
+ sudo chown postgres:postgres /mnt/data
+ pg_ctl -D /mnt/data/pgdata init
+ cp postgresql-default.conf /mnt/data/pgdata/postgresql.conf
+ pg_ctl -D /mnt/data/pgdata -l 20220913-mdraid-limit/0/xfs/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ cat /proc/mdstat
+ for scale in 10000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220913-mdraid-limit/0/xfs/10000
++ date +%s
+ t1=1663076797
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663076797.129458
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/18810A8
+ pgbench -i -s 10000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1663076797.129458'
+ d=1624.859475
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/18810A8'\'')'
+ w=128800551696
++ date +%s
+ t2=1663078421
+ echo '1663076797;1663078421;0;default;xfs;10000;init;1624.859475;128800551696'
++ date +%s
+ t1=1663078421
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663078421.998918
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=1D/FEA483B8
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1663078421.998918'
+ d=0.197214
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''1D/FEA483B8'\'')'
+ w=5053512
++ date +%s
+ t2=1663078422
+ echo '1663078421;1663078422;0;default;xfs;10000;vacuum;0.197214;5053512'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 10000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220913-mdraid-limit/0/xfs/10000/run-ro-1
++ date +%s
+ t1=1663078422
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=134337085440
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=156808655675
+ echo 'before;134337085440;22464135168;156808655675'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220913-mdraid-limit/0/xfs/10000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663078422.234208
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=1D/FEF1A000
+ pgbench -n -M prepared -S -j 8 -c 32 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220913-mdraid-limit/0/xfs/10000/run-ro-1/pgbench_log.tgz pgbench_log.12702 pgbench_log.12702.1 pgbench_log.12702.2 pgbench_log.12702.3 pgbench_log.12702.4 pgbench_log.12702.5 pgbench_log.12702.6 pgbench_log.12702.7
+ rm -f pgbench_log.12702 pgbench_log.12702.1 pgbench_log.12702.2 pgbench_log.12702.3 pgbench_log.12702.4 pgbench_log.12702.5 pgbench_log.12702.6 pgbench_log.12702.7
++ psql -t -A test -c 'select extract(epoch from now()) - 1663078422.234208'
+ d=903.446418
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''1D/FEF1A000'\'')'
+ w=5528
++ date +%s
+ t2=1663079325
++ cat 20220913-mdraid-limit/0/xfs/10000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=144228.084027
+ echo '1663078422;1663079325;0;default;xfs;10000;ro;144228.084027;903.446418;5528'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=134337085440
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=156808655675
+ echo 'after;134337085440;22464135168;156808655675'
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220913-mdraid-limit/0/xfs/10000/run-rw-1
++ date +%s
+ t1=1663079385
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=134337085440
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=156808655675
+ echo 'before;134337085440;22464135168;156808655675'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220913-mdraid-limit/0/xfs/10000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663079385.776635
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=1D/FEF1B648
+ pgbench -n -M prepared -R 10000 -L 6 -N -j 8 -c 32 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220913-mdraid-limit/0/xfs/10000/run-rw-1/pgbench_log.tgz pgbench_log.18284 pgbench_log.18284.1 pgbench_log.18284.2 pgbench_log.18284.3 pgbench_log.18284.4 pgbench_log.18284.5 pgbench_log.18284.6 pgbench_log.18284.7
+ rm -f pgbench_log.18284 pgbench_log.18284.1 pgbench_log.18284.2 pgbench_log.18284.3 pgbench_log.18284.4 pgbench_log.18284.5 pgbench_log.18284.6 pgbench_log.18284.7
++ psql -t -A test -c 'select extract(epoch from now()) - 1663079385.776635'
+ d=3601.297447
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''1D/FEF1B648'\'')'
+ w=282852734776
++ date +%s
+ t2=1663082987
++ cat 20220913-mdraid-limit/0/xfs/10000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=9264.232506
+ echo '1663079385;1663082987;0;default;xfs;10000;rw;9264.232506;3601.297447;282852734776'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=138014523392
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=160486101819
+ echo 'after;138014523392;22464135168;160486101819'
+ sleep 60
+ pg_ctl -D /mnt/data/pgdata -l 20220913-mdraid-limit/0/xfs/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down..... done
server stopped
+ sudo umount /mnt/data
+ for fs in xfs ext4
+ TESTDIR=20220913-mdraid-limit/0/ext4
+ '[' -d 20220913-mdraid-limit/0/ext4 ']'
+ mkdir -p 20220913-mdraid-limit/0/ext4
+ rate=10000
+ limit=6
+ CSV='0;default;ext4'
+ echo '===== default 0 ext4 10000 6 ====='
===== default 0 ext4 10000 6 =====
+ '[' ext4 == ext4 ']'
+ sudo mkfs.ext4 -F /dev/nvme0n1p1
mke2fs 1.46.5 (30-Dec-2021)
Discarding device blocks:         0/234422870 59244544/234422870 70254592/234422870 79691776/234422870 90701824/234422870119013376/234422870121634816/234422870123731968/234422870126353408/234422870128974848/234422870131072000/234422870133693440/234422870136314880/234422870138412032/234422870141033472/234422870143654912/234422870145752064/234422870148373504/234422870150994944/234422870153092096/234422870160432128/234422870189267968/234422870                   done                            
Creating filesystem with 234422870 4k blocks and 58613760 inodes
Filesystem UUID: db55a179-eb73-4bea-8ddb-91177a9c5a9d
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
	4096000, 7962624, 11239424, 20480000, 23887872, 71663616, 78675968, 
	102400000, 214990848

Allocating group tables:    0/7155         done                            
Writing inode tables:    0/7155         done                            
Creating journal (262144 blocks): done
Writing superblocks and filesystem accounting information:    0/7155         done

+ sleep 5
+ sudo mount -o relatime /dev/nvme0n1p1 /mnt/data
+ sudo chown postgres:postgres /mnt/data
+ pg_ctl -D /mnt/data/pgdata init
+ cp postgresql-default.conf /mnt/data/pgdata/postgresql.conf
+ pg_ctl -D /mnt/data/pgdata -l 20220913-mdraid-limit/0/ext4/pg.log -w start
waiting for server to start.... done
server started
+ ps ax
+ pg_config
+ psql postgres -c 'select * from pg_settings'
+ cat /proc/mdstat
+ for scale in 10000
+ dropdb --if-exists test
NOTICE:  database "test" does not exist, skipping
+ createdb test
+ mkdir 20220913-mdraid-limit/0/ext4/10000
++ date +%s
+ t1=1663083092
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663083092.836519
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=0/18810A8
+ pgbench -i -s 10000 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1663083092.836519'
+ d=1696.606170
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''0/18810A8'\'')'
+ w=128800551136
++ date +%s
+ t2=1663084789
+ echo '1663083092;1663084789;0;default;ext4;10000;init;1696.606170;128800551136'
++ date +%s
+ t1=1663084789
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663084789.453483
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=1D/FEA48188
+ vacuumdb --freeze --min-xid-age=1 test
++ psql -t -A test -c 'select extract(epoch from now()) - 1663084789.453483'
+ d=0.198890
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''1D/FEA48188'\'')'
+ w=5119608
++ date +%s
+ t2=1663084789
+ echo '1663084789;1663084789;0;default;ext4;10000;vacuum;0.198890;5119608'
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RO`
+ '[' 10000 == 50 ']'
+ rm -f 'pgbench_log.*'
+ mkdir 20220913-mdraid-limit/0/ext4/10000/run-ro-1
++ date +%s
+ t1=1663084789
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=134337085440
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=156808655675
+ echo 'before;134337085440;22464135168;156808655675'
++ ps ax
++ grep collect-stats
++ wc -l
++ grep -v grep
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 900 20220913-mdraid-limit/0/ext4/10000/run-ro-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663084789.692572
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=1D/FEF2A000
+ pgbench -n -M prepared -S -j 8 -c 32 -T 900 -l --sampling-rate=0.01 test
+ tar -czf 20220913-mdraid-limit/0/ext4/10000/run-ro-1/pgbench_log.tgz pgbench_log.8206 pgbench_log.8206.1 pgbench_log.8206.2 pgbench_log.8206.3 pgbench_log.8206.4 pgbench_log.8206.5 pgbench_log.8206.6 pgbench_log.8206.7
+ rm -f pgbench_log.8206 pgbench_log.8206.1 pgbench_log.8206.2 pgbench_log.8206.3 pgbench_log.8206.4 pgbench_log.8206.5 pgbench_log.8206.6 pgbench_log.8206.7
++ psql -t -A test -c 'select extract(epoch from now()) - 1663084789.692572'
+ d=903.504441
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''1D/FEF2A000'\'')'
+ w=6128
++ date +%s
+ t2=1663085693
++ cat 20220913-mdraid-limit/0/ext4/10000/run-ro-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=144207.366644
+ echo '1663084789;1663085693;0;default;ext4;10000;ro;144207.366644;903.504441;6128'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=134337085440
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=156808655675
+ echo 'after;134337085440;22464135168;156808655675'
+ sleep 60
+ psql test -c checkpoint
++ seq -s ' ' 1 1
+ for r in `seq -s ' ' 1 $RUNS_RW`
+ rm -f 'pgbench_log.*'
+ mkdir 20220913-mdraid-limit/0/ext4/10000/run-rw-1
++ date +%s
+ t1=1663085753
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=134337085440
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=156808655675
+ echo 'before;134337085440;22464135168;156808655675'
++ ps ax
++ grep collect-stats
++ grep -v grep
++ wc -l
+ c=0
+ '[' 0 '!=' 0 ']'
+ ./collect-stats.sh 3600 20220913-mdraid-limit/0/ext4/10000/run-rw-1
++ psql -t -A test -c 'select extract(epoch from now())'
+ s=1663085753.338808
++ psql -t -A test -c 'select pg_current_wal_lsn()'
+ w=1D/FEF2B8A0
+ pgbench -n -M prepared -R 10000 -L 6 -N -j 8 -c 32 -T 3600 -l --sampling-rate=0.01 test
+ tar -czf 20220913-mdraid-limit/0/ext4/10000/run-rw-1/pgbench_log.tgz pgbench_log.13744 pgbench_log.13744.1 pgbench_log.13744.2 pgbench_log.13744.3 pgbench_log.13744.4 pgbench_log.13744.5 pgbench_log.13744.6 pgbench_log.13744.7
+ rm -f pgbench_log.13744 pgbench_log.13744.1 pgbench_log.13744.2 pgbench_log.13744.3 pgbench_log.13744.4 pgbench_log.13744.5 pgbench_log.13744.6 pgbench_log.13744.7
++ psql -t -A test -c 'select extract(epoch from now()) - 1663085753.338808'
+ d=3601.340167
++ psql -t -A test -c 'select pg_wal_lsn_diff(pg_current_wal_lsn(), '\''1D/FEF2B8A0'\'')'
+ w=282595288600
++ date +%s
+ t2=1663089354
++ cat 20220913-mdraid-limit/0/ext4/10000/run-rw-1/pgbench.log
++ grep 'without initial'
++ awk '{print $3}'
+ tps=9249.233776
+ echo '1663085753;1663089354;0;default;ext4;10000;rw;9249.233776;3601.340167;282595288600'
++ psql -t -A test -c 'select sum(pg_table_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ st=138010386432
++ psql -t -A test -c 'select sum(pg_indexes_size(oid)) from pg_class where relnamespace = 2200 and relkind = '\''r'\'''
+ si=22464135168
++ psql -t -A test -c 'select pg_database_size('\''test'\'')'
+ sd=160481964859
+ echo 'after;138010386432;22464135168;160481964859'
+ sleep 60
+ pg_ctl -D /mnt/data/pgdata -l 20220913-mdraid-limit/0/ext4/pg.log -w -m immediate -t 3600 stop
waiting for server to shut down.... done
server stopped
+ sudo umount /mnt/data
